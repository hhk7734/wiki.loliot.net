"use strict";(self.webpackChunkwiki_loliot_net=self.webpackChunkwiki_loliot_net||[]).push([[75830],{28453:(n,e,s)=>{s.d(e,{R:()=>o,x:()=>c});var i=s(96540);const r={},l=i.createContext(r);function o(n){const e=i.useContext(l);return i.useMemo((function(){return"function"==typeof n?n(e):{...e,...n}}),[e,n])}function c(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(r):n.components||r:o(n.components),i.createElement(l.Provider,{value:e},n.children)}},78625:(n,e,s)=>{s.r(e),s.d(e,{assets:()=>d,contentTitle:()=>c,default:()=>h,frontMatter:()=>o,metadata:()=>i,toc:()=>t});const i=JSON.parse('{"id":"mlops/workflow/mpi-operator/mpijob","title":"MPIJob","description":"MPIJob","source":"@site/docs/mlops/workflow/mpi-operator/mpijob.mdx","sourceDirName":"mlops/workflow/mpi-operator","slug":"/mlops/workflow/mpi-operator/mpijob","permalink":"/docs/mlops/workflow/mpi-operator/mpijob","draft":false,"unlisted":false,"editUrl":"https://github.com/hhk7734/wiki/tree/main/docs/mlops/workflow/mpi-operator/mpijob.mdx","tags":[],"version":"current","lastUpdatedAt":1751560201000,"frontMatter":{"id":"mpijob","title":"MPIJob","sidebar_label":"MPIJob","description":"MPIJob","keywords":["mpi","operator","mpijob"]},"sidebar":"workflow","previous":{"title":"CRD","permalink":"/docs/mlops/workflow/awx/crd"},"next":{"title":"OpenMPI","permalink":"/docs/mlops/workflow/mpi-operator/openmpi"}}');var r=s(74848),l=s(28453);const o={id:"mpijob",title:"MPIJob",sidebar_label:"MPIJob",description:"MPIJob",keywords:["mpi","operator","mpijob"]},c=void 0,d={},t=[{value:"MPIJob",id:"mpijob",level:2},{value:"Container Base",id:"container-base",level:2}];function a(n){const e={a:"a",admonition:"admonition",code:"code",h2:"h2",li:"li",p:"p",pre:"pre",ul:"ul",...(0,l.R)(),...n.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(e.h2,{id:"mpijob",children:"MPIJob"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-yaml",children:'apiVersion: kubeflow.org/v2beta1\nkind: MPIJob\nspec:\n  mpiReplicaSpecs:\n    Launcher:\n      replicas: 1\n      template:\n        spec:\n          containers:\n            - name: mpi-launcher\n              image: ""\n              command: [mpirun]\n              args:\n                - -n\n                - "2"\n                - --bind-to\n                - none\n                - --map-by\n                - slot\n                - --mca\n                - pml\n                - ob1\n                - --mca\n                - btl\n                - ^openib\n                - -x\n                - LD_LIBRARY_PATH\n                - -x\n                - PATH\n                - python3\n                - train.py\n    Worker:\n      replicas: 2\n      template:\n        spec:\n          containers:\n            - name: mpi-worker\n              image: ""\n'})}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"sshAuthMountPath: <dir>"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\uc0dd\uc131\ub41c SSH Secret\uc758 \uacf5\uac1c\ud0a4\uc640 \uac1c\uc778\ud0a4\uac00 \uac01\uac01 ",(0,r.jsx)(e.code,{children:"authorized_keys"}),", ",(0,r.jsx)(e.code,{children:"id_rsa"}),"\ub85c \ub9c8\uc6b4\ud2b8\ub429\ub2c8\ub2e4."]}),"\n",(0,r.jsxs)(e.li,{children:["\uae30\ubcf8\uac12\uc740 ",(0,r.jsx)(e.code,{children:"/root/.ssh"}),"\uc785\ub2c8\ub2e4."]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.code,{children:"launcherCreationPolicy: AtStartup|WaitForWorkersReady"})}),"\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.code,{children:"runLauncherAsWorker: false"})}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"slotsPerWorker: 1"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"hostfile\uc5d0 \uc124\uc815\ub420 slot \uc218\uc785\ub2c8\ub2e4."}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"runPolicy"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"backoffLimit: <number>"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"Failed\ub85c \uac04\uc8fc\ud558\uae30 \uc804\uc5d0 Launcher\ub97c \uc7ac\uc2dc\ub3c4\ud558\ub294 \ud69f\uc218\uc785\ub2c8\ub2e4."}),"\n",(0,r.jsx)(e.li,{children:"\uae30\ubcf8\uac12\uc740 6\uc785\ub2c8\ub2e4."}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"ttlSecondsAfterFinished: <seconds>"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"Launcher\uac00 \uc644\ub8cc\ub41c \ud6c4 \uc0ad\uc81c\ub418\uae30\uae4c\uc9c0 \ub300\uae30\ud558\ub294 \uc2dc\uac04\uc785\ub2c8\ub2e4."}),"\n",(0,r.jsx)(e.li,{children:"\uae30\ubcf8\uac12\uc740 \ubb34\ud55c\uc785\ub2c8\ub2e4."}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"cleanPodPolicy: Running|All|None"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"Launcher\uac00 \uc644\ub8cc\ub41c \ud6c4 Pod\uc744 \uc815\ub9ac\ud558\ub294 \uc815\ucc45\uc785\ub2c8\ub2e4."}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"Running"}),": Running \uc0c1\ud0dc\uc778 Pod\uc744 \uc815\ub9ac\ud569\ub2c8\ub2e4. \uae30\ubcf8\uac12\uc785\ub2c8\ub2e4."]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"suspend: true|false"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"Launcher, Worker\ub97c \uc911\uc9c0\ud560\uc9c0 \uc5ec\ubd80\uc785\ub2c8\ub2e4."}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"mpiReplicaSpecs"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"Launcher"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"Job\uc774 \uc0dd\uc131\ub429\ub2c8\ub2e4."}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"replicas: <replicas>"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\uae30\ubcf8\uac12\uc740 1 \uc785\ub2c8\ub2e4."}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"restartPolicy: Always|OnFailure|Never"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\uae30\ubcf8\uac12\uc740 ",(0,r.jsx)(e.code,{children:"Nerver"}),"\uc785\ub2c8\ub2e4."]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.code,{children:"template: <core/v1.PodTemplateSpec>"})}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"Worker"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"Pod\uc774 \uc0dd\uc131\ub429\ub2c8\ub2e4."}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"template"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"spec"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"containers"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"command: []"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\uae30\ubcf8 \uac12\uc73c\ub85c ",(0,r.jsx)(e.code,{children:"[/usr/sbin/sshd, -De]"}),"\uac00 \uc124\uc815\ub429\ub2c8\ub2e4."]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.admonition,{type:"warning",children:(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.code,{children:"Launcher.template"})," \uc124\uc815\uc744 \ubcc0\uacbd\ud558\uba74 \uc0dd\uc131\ub41c launcher Job\uc744 \uc0ad\uc81c\ud574\uc57c \ubcc0\uacbd\ub41c \uc124\uc815\uc774 \uc801\uc6a9\ub429\ub2c8\ub2e4."]})}),"\n",(0,r.jsx)(e.h2,{id:"container-base",children:"Container Base"}),"\n",(0,r.jsx)(e.admonition,{title:"Reference",type:"info",children:(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.a,{href:"https://github.com/kubeflow/mpi-operator/tree/master/build/base",children:"mpi-operator GitHub / build / base"})}),"\n"]})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-dockerfile",metastring:'title="build/base/Dockerfile"',children:"FROM ubuntu:22.04\n\nARG PORT=2222\n\nRUN apt update && apt install -y --no-install-recommends \\\n    openssh-server \\\n    openssh-client \\\n    libcap2-bin \\\n    && apt-get clean \\\n    && rm -rf /var/lib/apt/lists/*\n\n# Add priviledge separation directoy to run sshd as root.\nRUN mkdir -p /var/run/sshd\n# Add capability to run sshd as non-root.\nRUN setcap CAP_NET_BIND_SERVICE=+eip /usr/sbin/sshd\nRUN apt remove -y libcap2-bin\n\nRUN cat <<EOF > /etc/ssh/ssh_config.d/50-mpiuser.conf\nHost *\n    StrictHostKeyChecking no\n    UserKnownHostsFile /dev/null\n    Port $PORT\nEOF\n\nRUN cat <<EOF > /etc/ssh/sshd_config.d/50-mpiuser.conf\nStrictModes no\nPort $PORT\nEOF\n\nRUN useradd -m -u 1000 mpiuser\n\nWORKDIR /home/mpiuser\n\nRUN cat <<EOF > /home/mpiuser/.sshd_config\nPidFile /home/mpiuser/sshd.pid\nHostKey /home/mpiuser/.ssh/id_rsa\nStrictModes no\nPort $PORT\nEOF\n"})}),"\n",(0,r.jsx)(e.p,{children:"\uc774 \uc774\ubbf8\uc9c0\uc5d0 MPI \ub77c\uc774\ube0c\ub7ec\ub9ac \ub4f1\uc744 \uc124\uce58\ud558\uc5ec \uc774\ubbf8\uc9c0\ub97c \ub9cc\ub4e0 \uacbd\uc6b0, \uc544\ub798\uc640 \uac19\uc740 \uc124\uc815\ub4e4\uc744 \uc0ac\uc6a9\ud558\uc5ec MPIJob\uc744 \uc2e4\ud589\ud558\uba74 \ub429\ub2c8\ub2e4."}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-yaml",children:"apiVersion: kubeflow.org/v2beta1\nkind: MPIJob\nspec:\n  sshAuthMountPath: /home/mpiuser/.ssh\n  mpiReplicaSpecs:\n    Launcher:\n      template:\n        spec:\n          containers:\n            - name: mpi-launcher\n              securityContext:\n                runAsUser: 1000\n              command:\n                - mpirun\n              args:\n                - -n\n                # ...\n    Worker:\n      template:\n        spec:\n          containers:\n            - name: mpi-worker\n              securityContext:\n                runAsUser: 1000\n              command:\n                - /usr/sbin/sshd\n              args:\n                - -De\n                - -f\n                - /home/mpiuser/.sshd_config\n"})})]})}function h(n={}){const{wrapper:e}={...(0,l.R)(),...n.components};return e?(0,r.jsx)(e,{...n,children:(0,r.jsx)(a,{...n})}):a(n)}}}]);