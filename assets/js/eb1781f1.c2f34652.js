"use strict";(self.webpackChunkwiki_loliot_net=self.webpackChunkwiki_loliot_net||[]).push([[36724],{39150:(e,s,t)=>{t.r(s),t.d(s,{assets:()=>o,contentTitle:()=>c,default:()=>m,frontMatter:()=>r,metadata:()=>n,toc:()=>l});const n=JSON.parse('{"id":"mlops/storage/aws-efs-csi-driver","title":"aws-efs-csi-driver","description":"aws-efs-csi-driver","source":"@site/docs/mlops/storage/aws-efs-csi-driver.mdx","sourceDirName":"mlops/storage","slug":"/mlops/storage/aws-efs-csi-driver","permalink":"/docs/mlops/storage/aws-efs-csi-driver","draft":false,"unlisted":false,"editUrl":"https://github.com/hhk7734/wiki/tree/main/docs/mlops/storage/aws-efs-csi-driver.mdx","tags":[],"version":"current","lastUpdatedAt":1734625390000,"frontMatter":{"id":"aws-efs-csi-driver","title":"aws-efs-csi-driver","sidebar_label":"aws-efs-csi-driver","description":"aws-efs-csi-driver","keywords":["aws-efs-csi-driver"]},"sidebar":"storage","previous":{"title":"aws-ebs-csi-driver","permalink":"/docs/mlops/storage/aws-ebs-csi-driver"},"next":{"title":"Ceph Storage Cluster","permalink":"/docs/mlops/storage/ceph/"}}');var i=t(74848),a=t(28453);const r={id:"aws-efs-csi-driver",title:"aws-efs-csi-driver",sidebar_label:"aws-efs-csi-driver",description:"aws-efs-csi-driver",keywords:["aws-efs-csi-driver"]},c=void 0,o={},l=[{value:"\uc0ac\uc804 \uc694\uad6c \uc0ac\ud56d",id:"\uc0ac\uc804-\uc694\uad6c-\uc0ac\ud56d",level:2},{value:"\uc124\uce58",id:"\uc124\uce58",level:2},{value:"EFS",id:"efs",level:2},{value:"StorageClass",id:"storageclass",level:2},{value:"Static Provisioning",id:"static-provisioning",level:3},{value:"Dynamic Provisioning",id:"dynamic-provisioning",level:3}];function d(e){const s={a:"a",admonition:"admonition",code:"code",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",ul:"ul",...(0,a.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(s.p,{children:"AWS EFS Container Storage Interface Driver"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:(0,i.jsx)(s.a,{href:"https://github.com/kubernetes-sigs/aws-efs-csi-driver",children:"https://github.com/kubernetes-sigs/aws-efs-csi-driver"})}),"\n"]}),"\n",(0,i.jsx)(s.h2,{id:"\uc0ac\uc804-\uc694\uad6c-\uc0ac\ud56d",children:"\uc0ac\uc804 \uc694\uad6c \uc0ac\ud56d"}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-ts",children:'import * as aws from "@pulumi/aws";\nimport * as variable from "@src/variable";\n\nconst awsEFSCSIDriverRoleName = "aws-efs-csi-driver-role";\nexport const awsEFSCSIDriverRole = new aws.iam.Role(\n\tawsEFSCSIDriverRoleName,\n\t{\n\t\tnamePrefix: `${awsEFSCSIDriverRoleName}-`,\n\t\tassumeRolePolicy: {\n\t\t\tVersion: "2012-10-17",\n\t\t\tStatement: [\n\t\t\t\t{\n\t\t\t\t\tEffect: "Allow",\n\t\t\t\t\tPrincipal: {\n\t\t\t\t\t\tFederated: variable.eks.core.eks.apply((eks) => eks.oidcProvider.arn),\n\t\t\t\t\t},\n\t\t\t\t\tCondition: {\n\t\t\t\t\t\tStringEquals: variable.eks.core.eks.apply((eks) => ({\n\t\t\t\t\t\t\t[`${eks.oidcProvider.url}:aud`]: "sts.amazonaws.com",\n\t\t\t\t\t\t\t[`${eks.oidcProvider.url}:sub`]:\n\t\t\t\t\t\t\t\t// system:serviceaccount:<namespace>:<serviceAccount>\n\t\t\t\t\t\t\t\t"system:serviceaccount:kube-system:aws-efs-csi-driver",\n\t\t\t\t\t\t})),\n\t\t\t\t\t},\n\t\t\t\t\tAction: "sts:AssumeRoleWithWebIdentity",\n\t\t\t\t},\n\t\t\t],\n\t\t},\n\t\ttags: {\n\t\t\tName: awsEFSCSIDriverRoleName,\n\t\t\t"loliot.net/stack": variable.stackName,\n\t\t},\n\t},\n\t{ protect: true },\n);\n\nnew aws.iam.RolePolicyAttachment(\n\t"aws-efs-csi-driver-rpa-0",\n\t{\n\t\tpolicyArn: "arn:aws:iam::aws:policy/service-role/AmazonEFSCSIDriverPolicy",\n\t\trole: awsEFSCSIDriverRole.name,\n\t},\n\t{ protect: true },\n);\n'})}),"\n",(0,i.jsx)(s.h2,{id:"\uc124\uce58",children:"\uc124\uce58"}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-shell",children:"helm repo add aws-efs-csi-driver https://kubernetes-sigs.github.io/aws-efs-csi-driver\n"})}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-shell",children:"helm repo update aws-efs-csi-driver \\\n&& helm search repo aws-efs-csi-driver/aws-efs-csi-driver -l | head -n 10\n"})}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-shell",children:"helm show values aws-efs-csi-driver/aws-efs-csi-driver \\\n    --version 2.5.0 \\\n    > aws-efs-csi-driver-values.yaml\n"})}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-yaml",metastring:'title="aws-efs-csi-driver-values.yaml"',children:"controller:\n  serviceAccount:\n    create: true\n    name: aws-efs-csi-driver\n    annotations:\n      eks.amazonaws.com/role-arn: arn:aws:iam::<account-id>:role/<role-name>\n"})}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-shell",children:"helm template aws-efs-csi-driver aws-efs-csi-driver/aws-efs-csi-driver \\\n    --version 2.5.0 \\\n    -n kube-system \\\n    -f aws-efs-csi-driver-values.yaml \\\n    > aws-efs-csi-driver.yaml\n"})}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-shell",children:"helm upgrade aws-efs-csi-driver aws-efs-csi-driver/aws-efs-csi-driver \\\n    --install \\\n    --history-max 5 \\\n    --version 2.5.0 \\\n    -n kube-system \\\n    -f aws-efs-csi-driver-values.yaml\n"})}),"\n",(0,i.jsx)(s.h2,{id:"efs",children:"EFS"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:(0,i.jsx)(s.a,{href:"https://docs.aws.amazon.com/efs/latest/ug/how-it-works.html",children:"https://docs.aws.amazon.com/efs/latest/ug/how-it-works.html"})}),"\n"]}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-ts",children:'import * as aws from "@pulumi/aws";\nimport * as variable from "@src/variable";\n\nconst efs0Name = "efs-0";\nconst efs0 = new aws.efs.FileSystem(efs0Name, {\n\tavailabilityZoneName: "ap-northeast-2a",\n\tperformanceMode: "generalPurpose",\n\tthroughputMode: "bursting",\n\tlifecyclePolicies: [\n\t\t{\n\t\t\ttransitionToIa: "AFTER_14_DAYS",\n\t\t},\n\t],\n\tencrypted: true,\n\ttags: {\n\t\tName: efs0Name,\n\t\t"loliot.net/stack": variable.stackName,\n\t},\n});\n\nconst efs0SecurityGroupName = "efs-0";\nconst vpcId = variable.eks.core.vpc.apply((vpc) => vpc.vpc.id);\nconst cidrBlocks = variable.eks.core.vpc.apply((vpc) => vpc.vpc.cidrBlock);\nconst efs0SecurityGroup = new aws.ec2.SecurityGroup(\n\tefs0SecurityGroupName,\n\t{\n\t\tnamePrefix: efs0SecurityGroupName,\n\t\tvpcId: vpcId,\n\t\tingress: [\n\t\t\t{\n\t\t\t\tfromPort: 2049,\n\t\t\t\ttoPort: 2049,\n\t\t\t\tprotocol: "tcp",\n\t\t\t\tcidrBlocks: [cidrBlocks],\n\t\t\t},\n\t\t],\n\t\tegress: [{ fromPort: 0, toPort: 0, protocol: "all", cidrBlocks: ["0.0.0.0/0"] }],\n\t\ttags: {\n\t\t\tName: efs0SecurityGroupName,\n\t\t\t"loliot.net/stack": variable.stackName,\n\t\t},\n\t},\n\t{ parent: efs0 },\n);\n\nconst efs0MountTarget0Name = "efs-0";\nconst subnetId = variable.eks.core.vpc.apply((vpc) => vpc.privateSubnet1.id);\nconst efs0MountTarget0 = new aws.efs.MountTarget(\n\tefs0MountTarget0Name,\n\t{\n\t\tfileSystemId: efs0.id,\n\t\tsecurityGroups: [efs0SecurityGroup.id],\n\t\tsubnetId: subnetId,\n\t},\n\t{\n\t\tparent: efs0,\n\t},\n);\n'})}),"\n",(0,i.jsx)(s.h2,{id:"storageclass",children:"StorageClass"}),"\n",(0,i.jsx)(s.admonition,{type:"info",children:(0,i.jsx)(s.p,{children:"Provisioning \uc2dc\uc5d0 \uc120\uc5b8\ub418\ub294 storage \ud06c\uae30\ub294 \ub354\ubbf8 \uac12\uc785\ub2c8\ub2e4. \uc2e4\uc81c \uc0ac\uc6a9 \uc2dc\uc5d0\ub294 \uc81c\ud55c\uc774 \uc5c6\uc2b5\ub2c8\ub2e4."})}),"\n",(0,i.jsx)(s.h3,{id:"static-provisioning",children:"Static Provisioning"}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-yaml",metastring:'title="storage/aws-efs-csi-driver/static/efs-sp-sc.yaml"',children:"apiVersion: storage.k8s.io/v1\nkind: StorageClass\nmetadata:\n  name: efs-sp-sc\nprovisioner: efs.csi.aws.com\n"})}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-shell",children:"pulumi stack output efs_id\n"})}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-yaml",metastring:'title="storage/aws-efs-csi-driver/static/efs-sp-pvc.yaml" {15}',children:"apiVersion: v1\nkind: PersistentVolume\nmetadata:\n  name: efs-sp-pv\nspec:\n  capacity:\n    storage: 5Gi\n  volumeMode: Filesystem\n  accessModes:\n    - ReadWriteMany\n  persistentVolumeReclaimPolicy: Retain\n  storageClassName: efs-sp-sc\n  csi:\n    driver: efs.csi.aws.com\n    volumeHandle: <FileSystemId>[:<SubPath>][:<AccessPointId>]\n\n---\napiVersion: v1\nkind: PersistentVolumeClaim\nmetadata:\n  name: efs-sp-pvc\nspec:\n  accessModes:\n    - ReadWriteMany\n  storageClassName: efs-sp-sc\n  resources:\n    requests:\n      storage: 5Gi\n"})}),"\n",(0,i.jsx)(s.admonition,{type:"info",children:(0,i.jsxs)(s.p,{children:[(0,i.jsx)(s.code,{children:"<FileSystemId>"}),", ",(0,i.jsx)(s.code,{children:"<FileSystemId>:<SubPath>"}),", ",(0,i.jsx)(s.code,{children:"<FileSystemId>::<AccessPointId>"}),", ",(0,i.jsx)(s.code,{children:"<FileSystemId>:<SubPath>:<AccessPointId>"}),"\uc870\ud569\uc774 \uac00\ub2a5\ud569\ub2c8\ub2e4."]})}),"\n",(0,i.jsx)(s.h3,{id:"dynamic-provisioning",children:"Dynamic Provisioning"}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-yaml",metastring:'title="storage/aws-efs-csi-driver/dynamic/efs-dp-sc.yaml" {8-10}',children:'apiVersion: storage.k8s.io/v1\nkind: StorageClass\nmetadata:\n  name: efs-dp-sc\nprovisioner: efs.csi.aws.com\nparameters:\n  provisioningMode: efs-ap # PVC\ub97c \uc120\uc5b8\ud558\uba74 AccessPoint\uac00 \uc0dd\uc131\ub429\ub2c8\ub2e4.\n  fileSystemId: <FileSystemId>\n  directoryPerms: "755"\n  basePath: "/k8s" # Default: "/". AccessPoint\uc758 \ub8e8\ud2b8 \ub514\ub809\ud130\ub9ac\ub4e4\uc774 \uc0dd\uc131\ub420 \uc704\uce58 \uc785\ub2c8\ub2e4.\n'})}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-yaml",metastring:'title="storage/aws-efs-csi-driver/dynamic/efs-dp-pvc.yaml"',children:"apiVersion: v1\nkind: PersistentVolumeClaim\nmetadata:\n  name: efs-dp-pvc\nspec:\n  accessModes:\n    - ReadWriteMany\n  storageClassName: efs-dp-sc\n  resources:\n    requests:\n      storage: 5Gi\n"})})]})}function m(e={}){const{wrapper:s}={...(0,a.R)(),...e.components};return s?(0,i.jsx)(s,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},28453:(e,s,t)=>{t.d(s,{R:()=>r,x:()=>c});var n=t(96540);const i={},a=n.createContext(i);function r(e){const s=n.useContext(a);return n.useMemo((function(){return"function"==typeof e?e(s):{...s,...e}}),[s,e])}function c(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:r(e.components),n.createElement(a.Provider,{value:s},e.children)}}}]);