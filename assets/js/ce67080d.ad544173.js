"use strict";(self.webpackChunkwiki_loliot_net=self.webpackChunkwiki_loliot_net||[]).push([[70162],{5421:(e,n,a)=>{a.r(n),a.d(n,{assets:()=>u,contentTitle:()=>d,default:()=>v,frontMatter:()=>c,metadata:()=>l,toc:()=>p});const l=JSON.parse('{"id":"lang/python/libraries/yolov4/python-yolov4-training","title":"YOLOv4 Training on Colab","description":"YOLOv4 Training on Colab","source":"@site/docs/lang/python/libraries/yolov4/python-yolov4-training.mdx","sourceDirName":"lang/python/libraries/yolov4","slug":"/lang/python/libraries/yolov4/python-yolov4-training","permalink":"/docs/lang/python/libraries/yolov4/python-yolov4-training","draft":false,"unlisted":false,"editUrl":"https://github.com/hhk7734/wiki/tree/main/docs/lang/python/libraries/yolov4/python-yolov4-training.mdx","tags":[],"version":"current","lastUpdatedAt":1703257929000,"frontMatter":{"id":"python-yolov4-training","title":"YOLOv4 Training on Colab","sidebar_label":"Training","description":"YOLOv4 Training on Colab","keywords":["Neural Network","YOLOv4","training","Colab"]},"sidebar":"python","previous":{"title":"Dataset","permalink":"/docs/lang/python/libraries/yolov4/python-yolov4-dataset"},"next":{"title":"mAP","permalink":"/docs/lang/python/libraries/yolov4/python-yolov4-map"}}');var t=a(74848),o=a(28453),r=a(49489),i=a(7227),s=a(98180);const c={id:"python-yolov4-training",title:"YOLOv4 Training on Colab",sidebar_label:"Training",description:"YOLOv4 Training on Colab",keywords:["Neural Network","YOLOv4","training","Colab"]},d=void 0,u={},p=[{value:"Training Step",id:"training-step",level:2},{value:"Installation",id:"installation",level:3},{value:"Prepare dataset",id:"prepare-dataset",level:3},{value:"Set yolo parameters",id:"set-yolo-parameters",level:3},{value:"Load pre-trained weights",id:"load-pre-trained-weights",level:3},{value:"Freeze some layers",id:"freeze-some-layers",level:3},{value:"Set callbacks and Compile",id:"set-callbacks-and-compile",level:3},{value:"Call fit()",id:"call-fit",level:3},{value:"Full script",id:"full-script",level:3},{value:"TensorBoard",id:"tensorboard",level:2}];function h(e){const n={code:"code",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",ul:"ul",...(0,o.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.h2,{id:"training-step",children:"Training Step"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"2020-10-15"}),"\n",(0,t.jsx)(n.li,{children:"Google Colab"}),"\n",(0,t.jsx)(n.li,{children:"TF: v2.3.0"}),"\n",(0,t.jsx)(n.li,{children:"yolov4: v1.2.1"}),"\n",(0,t.jsx)(n.li,{children:"coco 2017 dataset"}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"installation",children:"Installation"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:"python3 -m pip install -U yolov4\n"})}),"\n",(0,t.jsx)(n.h3,{id:"prepare-dataset",children:"Prepare dataset"}),"\n",(0,t.jsxs)(n.p,{children:["Usually, I create an image path related file using only image file names. Then, I make full path using ",(0,t.jsx)(n.code,{children:"image_path_prefix"})," in ",(0,t.jsx)(n.code,{children:"yolo.load_dataset()"}),"."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-text",metastring:'title="train2017.txt"',children:"000000000009.jpg 45,0.479492,0.688771,0.955609,0.595500 45,0.736516,0.247188,0.498875,0.476417 50,0.637063,0.732938,0.494125,0.510583 45,0.339438,0.418896,0.678875,0.781500 49,0.646836,0.132552,0.118047,0.096937 49,0.773148,0.129802,0.090734,0.097229 49,0.668297,0.226906,0.131281,0.146896 49,0.642859,0.079219,0.148063,0.148062\n000000000025.jpg 23,0.770336,0.489695,0.335891,0.697559 23,0.185977,0.901608,0.206297,0.129554\n000000000030.jpg 58,0.519219,0.451121,0.398250,0.757290 75,0.501188,0.592138,0.260000,0.456192\n\n...\n"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-shell",children:"/content\n\u251c\u2500\u2500 train2017\n\u2502   \u251c\u2500\u2500 000000000009.jpg\n\u2502   \u251c\u2500\u2500 000000000025.jpg\n\u2502   \u251c\u2500\u2500 000000000030.jpg\n\u2502   \u2514\u2500\u2500 ...\n\u2514\u2500\u2500 ...\n"})}),"\n",(0,t.jsxs)(r.A,{groupId:"yolov4-version",defaultValue:"v3",values:[{label:"v3",value:"v3"},{label:"v2",value:"v2"}],children:[(0,t.jsx)(i.A,{value:"v3",children:(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:'# Call YOLODataset after yolo.config.parse_cfg():\ntrain_dataset = YOLODataset(\n    config=yolo.config,\n    dataset_list="/content/drive/My Drive/Hard_Soft/NN/coco/train2017.txt",\n    image_path_prefix="/content/train2017",\n    training=True,\n)\n'})})}),(0,t.jsx)(i.A,{value:"v2",children:(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:'# Call load_dataset() after yolo.<parameter>: anchors, classes, input_size, xyscales, ...\ntrain_data_set = yolo.load_dataset(\n    "/content/drive/My Drive/Hard_Soft/NN/coco/train2017.txt",\n    image_path_prefix="/content/train2017",\n    label_smoothing=0.05\n)\n'})})})]}),"\n",(0,t.jsx)(n.h3,{id:"set-yolo-parameters",children:"Set yolo parameters"}),"\n",(0,t.jsxs)(r.A,{groupId:"yolov4-version",defaultValue:"v3",values:[{label:"v3",value:"v3"},{label:"v2",value:"v2"}],children:[(0,t.jsxs)(i.A,{value:"v3",children:[(0,t.jsxs)(n.p,{children:["Use ",(0,t.jsx)(n.code,{children:"<yolo-model>.cfg"}),"(darknet)."]}),(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:'yolo = YOLOv4()\n\nyolo.config.parse_names("coco.names")\nyolo.config.parse_cfg("yolov4-tiny.cfg")\n'})})]}),(0,t.jsx)(i.A,{value:"v2",children:(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:'yolo = YOLOv4(tiny=True)\nyolo.classes = "/content/drive/My Drive/Hard_Soft/NN/coco/coco.names"\nyolo.input_size = 608 # == width, height\nyolo.batch_size = 32\n\n# Call make_model() after yolo.<parameter>: anchors, classes, input_size, xyscales, ...\nyolo.make_model()\n'})})})]}),"\n",(0,t.jsx)(n.h3,{id:"load-pre-trained-weights",children:"Load pre-trained weights"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:'yolo.load_weights(\n    "/content/drive/My Drive/Hard_Soft/NN/yolov4/yolov4-tiny.conv.29",\n    weights_type="yolo"\n)\n'})}),"\n",(0,t.jsx)(n.h3,{id:"freeze-some-layers",children:"Freeze some layers"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:"# Tested on v3 only\nfor i in range(29):\n    yolo.model.get_layer(index=i).trainable = False\n"})}),"\n",(0,t.jsx)(n.h3,{id:"set-callbacks-and-compile",children:"Set callbacks and Compile"}),"\n",(0,t.jsxs)(r.A,{groupId:"yolov4-version",defaultValue:"v3",values:[{label:"v3",value:"v3"},{label:"v2",value:"v2"}],children:[(0,t.jsxs)(i.A,{value:"v3",children:[(0,t.jsxs)(n.p,{children:["Use ",(0,t.jsx)(n.code,{children:"<yolo-model>.cfg"}),"(darknet)."]}),(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:'yolo.compile()\n\n_callbacks = [\n    callbacks.TerminateOnNaN(),\n    callbacks.TensorBoard(\n        log_dir="/content/drive/MyDrive/Hard_Soft/NN/logs",\n        update_freq=200,\n        histogram_freq=1,\n    ),\n    SaveWeightsCallback(\n        yolo=yolo,\n        dir_path="/content/drive/MyDrive/Hard_Soft/NN/trained",\n        weights_type="yolo",\n        step_per_save=2000,\n    ),\n]\n'})})]}),(0,t.jsx)(i.A,{value:"v2",children:(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:'epochs = 400\nlr = 1e-4\n\noptimizer = optimizers.Adam(learning_rate=lr)\nyolo.compile(optimizer=optimizer, loss_iou_type="ciou")\n\ndef lr_scheduler(epoch):\n    if epoch < int(epochs * 0.5):\n        return lr\n    if epoch < int(epochs * 0.8):\n        return lr * 0.5\n    if epoch < int(epochs * 0.9):\n        return lr * 0.1\n    return lr * 0.01\n\n_callbacks = [\n    callbacks.LearningRateScheduler(lr_scheduler),\n    callbacks.TerminateOnNaN(),\n    callbacks.TensorBoard(\n        log_dir="/content/drive/My Drive/Hard_Soft/NN/logs",\n    ),\n    SaveWeightsCallback(\n        yolo=yolo, dir_path="/content/drive/My Drive/Hard_Soft/NN/trained",\n        weights_type="yolo", epoch_per_save=10\n    ),\n]\n'})})})]}),"\n",(0,t.jsx)(n.h3,{id:"call-fit",children:"Call fit()"}),"\n",(0,t.jsxs)(r.A,{groupId:"yolov4-version",defaultValue:"v3",values:[{label:"v3",value:"v3"},{label:"v2",value:"v2"}],children:[(0,t.jsx)(i.A,{value:"v3",children:(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:"yolo.fit(\n    train_dataset,\n    callbacks=_callbacks,\n    validation_data=val_dataset,\n    verbose=3,  # 3: print step info\n)\n"})})}),(0,t.jsx)(i.A,{value:"v2",children:(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:"yolo.fit(\n    train_data_set,\n    epochs=epochs,\n    callbacks=_callbacks,\n    validation_data=val_data_set,\n    validation_steps=50,\n    validation_freq=5,\n    steps_per_epoch=100,\n)\n"})})})]}),"\n",(0,t.jsx)(n.h3,{id:"full-script",children:"Full script"}),"\n",(0,t.jsxs)(r.A,{groupId:"yolov4-version",defaultValue:"v3",values:[{label:"v3",value:"v3"},{label:"v2",value:"v2"}],children:[(0,t.jsxs)(i.A,{value:"v3",children:[(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"2021-02-13"}),"\n",(0,t.jsx)(n.li,{children:"OS: Ubuntu 20.04"}),"\n",(0,t.jsx)(n.li,{children:"TF: v2.4.1"}),"\n",(0,t.jsx)(n.li,{children:"yolov4: v3.0.0"}),"\n"]}),(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:'from tensorflow.keras import callbacks\n\nfrom yolov4.tf import YOLOv4, YOLODataset, SaveWeightsCallback\n\nyolo = YOLOv4()\n\nyolo.config.parse_names("coco.names")\nyolo.config.parse_cfg("yolov4-tiny.cfg")\n\nyolo.make_model()\nyolo.load_weights(\n    "/content/drive/MyDrive/Hard_Soft/NN/yolov4/yolov4-tiny.conv.29",\n    weights_type="yolo",\n)\nyolo.summary(summary_type="yolo")\n\nfor i in range(29):\n    yolo.model.get_layer(index=i).trainable = False\n\nyolo.summary()\n\ntrain_dataset = YOLODataset(\n    config=yolo.config,\n    dataset_list="/content/drive/MyDrive/Hard_Soft/NN/coco/train2017.txt",\n    image_path_prefix="/content/train2017",\n    training=True,\n)\n\nval_dataset = YOLODataset(\n    config=yolo.config,\n    dataset_list="/content/drive/MyDrive/Hard_Soft/NN/coco/val2017.txt",\n    image_path_prefix="/content/val2017",\n    training=False,\n)\n\nyolo.compile()\n\n_callbacks = [\n    callbacks.TerminateOnNaN(),\n    callbacks.TensorBoard(\n        log_dir="/content/drive/MyDrive/Hard_Soft/NN/logs",\n        update_freq=200,\n        histogram_freq=1,\n    ),\n    SaveWeightsCallback(\n        yolo=yolo,\n        dir_path="/content/drive/MyDrive/Hard_Soft/NN/trained",\n        weights_type="yolo",\n        step_per_save=2000,\n    ),\n]\n\nyolo.fit(\n    train_dataset,\n    callbacks=_callbacks,\n    validation_data=val_dataset,\n    verbose=3,  # 3: print step info\n)\n'})})]}),(0,t.jsx)(i.A,{value:"v2",children:(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:'from tensorflow.keras import callbacks, optimizers\nfrom yolov4.tf import SaveWeightsCallback, YOLOv4\nimport time\n\nyolo = YOLOv4(tiny=True)\nyolo.classes = "/content/drive/My Drive/Hard_Soft/NN/coco/coco.names"\nyolo.input_size = 608\nyolo.batch_size = 32\n\nyolo.make_model()\nyolo.load_weights(\n    "/content/drive/My Drive/Hard_Soft/NN/yolov4/yolov4-tiny.conv.29",\n    weights_type="yolo"\n)\n\ntrain_data_set = yolo.load_dataset(\n    "/content/drive/My Drive/Hard_Soft/NN/coco/train2017.txt",\n    image_path_prefix="/content/train2017",\n    label_smoothing=0.05\n)\nval_data_set = yolo.load_dataset(\n    "/content/drive/My Drive/Hard_Soft/NN/coco/val2017.txt",\n    image_path_prefix="/content/val2017",\n    training=False\n)\n\nepochs = 400\nlr = 1e-4\n\noptimizer = optimizers.Adam(learning_rate=lr)\nyolo.compile(optimizer=optimizer, loss_iou_type="ciou")\n\ndef lr_scheduler(epoch):\n    if epoch < int(epochs * 0.5):\n        return lr\n    if epoch < int(epochs * 0.8):\n        return lr * 0.5\n    if epoch < int(epochs * 0.9):\n        return lr * 0.1\n    return lr * 0.01\n\n_callbacks = [\n    callbacks.LearningRateScheduler(lr_scheduler),\n    callbacks.TerminateOnNaN(),\n    callbacks.TensorBoard(\n        log_dir="/content/drive/My Drive/Hard_Soft/NN/logs",\n    ),\n    SaveWeightsCallback(\n        yolo=yolo, dir_path="/content/drive/My Drive/Hard_Soft/NN/trained",\n        weights_type="yolo", epoch_per_save=10\n    ),\n]\n\nyolo.fit(\n    train_data_set,\n    epochs=epochs,\n    callbacks=_callbacks,\n    validation_data=val_data_set,\n    validation_steps=50,\n    validation_freq=5,\n    steps_per_epoch=100,\n)\n'})})})]}),"\n",(0,t.jsx)(n.h2,{id:"tensorboard",children:"TensorBoard"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-shell",children:"tensorboard --logdir logs\n"})}),"\n",(0,t.jsx)("center",{children:(0,t.jsx)("img",{src:(0,s.Ay)("img/lang/python/libraries/yolov4/yolov4-training-tensorboard.png")})})]})}function v(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(h,{...e})}):h(e)}},7227:(e,n,a)=>{a.d(n,{A:()=>r});a(96540);var l=a(34164);const t={tabItem:"tabItem_Ymn6"};var o=a(74848);function r({children:e,hidden:n,className:a}){return(0,o.jsx)("div",{role:"tabpanel",className:(0,l.A)(t.tabItem,a),hidden:n,children:e})}},28453:(e,n,a)=>{a.d(n,{R:()=>r,x:()=>i});var l=a(96540);const t={},o=l.createContext(t);function r(e){const n=l.useContext(o);return l.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function i(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:r(e.components),l.createElement(o.Provider,{value:n},e.children)}},49489:(e,n,a)=>{a.d(n,{A:()=>N});var l=a(96540),t=a(34164),o=a(18630),r=a(24245),i=a(56347),s=a(36494),c=a(62814),d=a(67548),u=a(69900);function p(e){return l.Children.toArray(e).filter(e=>"\n"!==e).map(e=>{if(!e||(0,l.isValidElement)(e)&&function(e){const{props:n}=e;return!!n&&"object"==typeof n&&"value"in n}(e))return e;throw new Error(`Docusaurus error: Bad <Tabs> child <${"string"==typeof e.type?e.type:e.type.name}>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.`)})?.filter(Boolean)??[]}function h(e){const{values:n,children:a}=e;return(0,l.useMemo)(()=>{const e=n??function(e){return p(e).map(({props:{value:e,label:n,attributes:a,default:l}})=>({value:e,label:n,attributes:a,default:l}))}(a);return function(e){const n=(0,d.XI)(e,(e,n)=>e.value===n.value);if(n.length>0)throw new Error(`Docusaurus error: Duplicate values "${n.map(e=>e.value).join(", ")}" found in <Tabs>. Every value needs to be unique.`)}(e),e},[n,a])}function v({value:e,tabValues:n}){return n.some(n=>n.value===e)}function y({queryString:e=!1,groupId:n}){const a=(0,i.W6)(),t=function({queryString:e=!1,groupId:n}){if("string"==typeof e)return e;if(!1===e)return null;if(!0===e&&!n)throw new Error('Docusaurus error: The <Tabs> component groupId prop is required if queryString=true, because this value is used as the search param name. You can also provide an explicit value such as queryString="my-search-param".');return n??null}({queryString:e,groupId:n});return[(0,c.aZ)(t),(0,l.useCallback)(e=>{if(!t)return;const n=new URLSearchParams(a.location.search);n.set(t,e),a.replace({...a.location,search:n.toString()})},[t,a])]}function g(e){const{defaultValue:n,queryString:a=!1,groupId:t}=e,o=h(e),[r,i]=(0,l.useState)(()=>function({defaultValue:e,tabValues:n}){if(0===n.length)throw new Error("Docusaurus error: the <Tabs> component requires at least one <TabItem> children component");if(e){if(!v({value:e,tabValues:n}))throw new Error(`Docusaurus error: The <Tabs> has a defaultValue "${e}" but none of its children has the corresponding value. Available values are: ${n.map(e=>e.value).join(", ")}. If you intend to show no default tab, use defaultValue={null} instead.`);return e}const a=n.find(e=>e.default)??n[0];if(!a)throw new Error("Unexpected error: 0 tabValues");return a.value}({defaultValue:n,tabValues:o})),[c,d]=y({queryString:a,groupId:t}),[p,g]=function({groupId:e}){const n=function(e){return e?`docusaurus.tab.${e}`:null}(e),[a,t]=(0,u.Dv)(n);return[a,(0,l.useCallback)(e=>{n&&t.set(e)},[n,t])]}({groupId:t}),m=(()=>{const e=c??p;return v({value:e,tabValues:o})?e:null})();(0,s.A)(()=>{m&&i(m)},[m]);return{selectedValue:r,selectValue:(0,l.useCallback)(e=>{if(!v({value:e,tabValues:o}))throw new Error(`Can't select invalid tab value=${e}`);i(e),d(e),g(e)},[d,g,o]),tabValues:o}}var m=a(11062);const f={tabList:"tabList__CuJ",tabItem:"tabItem_LNqP"};var _=a(74848);function b({className:e,block:n,selectedValue:a,selectValue:l,tabValues:o}){const i=[],{blockElementScrollPositionUntilNextRender:s}=(0,r.a_)(),c=e=>{const n=e.currentTarget,t=i.indexOf(n),r=o[t].value;r!==a&&(s(n),l(r))},d=e=>{let n=null;switch(e.key){case"Enter":c(e);break;case"ArrowRight":{const a=i.indexOf(e.currentTarget)+1;n=i[a]??i[0];break}case"ArrowLeft":{const a=i.indexOf(e.currentTarget)-1;n=i[a]??i[i.length-1];break}}n?.focus()};return(0,_.jsx)("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,t.A)("tabs",{"tabs--block":n},e),children:o.map(({value:e,label:n,attributes:l})=>(0,_.jsx)("li",{role:"tab",tabIndex:a===e?0:-1,"aria-selected":a===e,ref:e=>{i.push(e)},onKeyDown:d,onClick:c,...l,className:(0,t.A)("tabs__item",f.tabItem,l?.className,{"tabs__item--active":a===e}),children:n??e},e))})}function x({lazy:e,children:n,selectedValue:a}){const o=(Array.isArray(n)?n:[n]).filter(Boolean);if(e){const e=o.find(e=>e.props.value===a);return e?(0,l.cloneElement)(e,{className:(0,t.A)("margin-top--md",e.props.className)}):null}return(0,_.jsx)("div",{className:"margin-top--md",children:o.map((e,n)=>(0,l.cloneElement)(e,{key:n,hidden:e.props.value!==a}))})}function j(e){const n=g(e);return(0,_.jsxs)("div",{className:(0,t.A)(o.G.tabs.container,"tabs-container",f.tabList),children:[(0,_.jsx)(b,{...n,...e}),(0,_.jsx)(x,{...n,...e})]})}function N(e){const n=(0,m.A)();return(0,_.jsx)(j,{...e,children:p(e.children)},String(n))}}}]);