"use strict";(self.webpackChunkwiki_loliot_net=self.webpackChunkwiki_loliot_net||[]).push([[71698],{70715:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>i,default:()=>p,frontMatter:()=>s,metadata:()=>r,toc:()=>c});const r=JSON.parse('{"id":"mlops/mlops/provisioning/karpenter/spot-event","title":"Karpenter Spot Event","description":"Karpenter Spot Event","source":"@site/docs/mlops/mlops/provisioning/karpenter/spot-event.mdx","sourceDirName":"mlops/mlops/provisioning/karpenter","slug":"/mlops/mlops/provisioning/karpenter/spot-event","permalink":"/docs/mlops/mlops/provisioning/karpenter/spot-event","draft":false,"unlisted":false,"editUrl":"https://github.com/hhk7734/wiki/tree/main/docs/mlops/mlops/provisioning/karpenter/spot-event.mdx","tags":[],"version":"current","lastUpdatedAt":1739979444000,"frontMatter":{"id":"spot-event","title":"Karpenter Spot Event","sidebar_label":"Spot Event","description":"Karpenter Spot Event","keywords":["karpenter","spot"]},"sidebar":"mlops","previous":{"title":"Karpenter","permalink":"/docs/mlops/mlops/provisioning/karpenter/"},"next":{"title":"CRD","permalink":"/docs/mlops/mlops/provisioning/karpenter/crd"}}');var a=n(74848),o=n(28453);const s={id:"spot-event",title:"Karpenter Spot Event",sidebar_label:"Spot Event",description:"Karpenter Spot Event",keywords:["karpenter","spot"]},i=void 0,l={},c=[{value:"SQS \uc0dd\uc131",id:"sqs-\uc0dd\uc131",level:2},{value:"EventBridge \ucd94\uac00",id:"eventbridge-\ucd94\uac00",level:2},{value:"Client",id:"client",level:2},{value:"Karpenter \uc124\uc815",id:"karpenter-\uc124\uc815",level:3},{value:"AWS Node Termination Handler",id:"aws-node-termination-handler",level:3}];function u(e){const t={a:"a",code:"code",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",ul:"ul",...(0,o.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)(t.ul,{children:["\n",(0,a.jsx)(t.li,{children:(0,a.jsx)(t.a,{href:"https://github.com/aws/karpenter/blob/main/website/content/en/preview/getting-started/getting-started-with-karpenter/cloudformation.yaml",children:"https://github.com/aws/karpenter/blob/main/website/content/en/preview/getting-started/getting-started-with-karpenter/cloudformation.yaml"})}),"\n"]}),"\n",(0,a.jsx)(t.h2,{id:"sqs-\uc0dd\uc131",children:"SQS \uc0dd\uc131"}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-ts",children:'import * as aws from "@pulumi/aws";\nimport * as variable from "@src/variable";\n\nconst karpenterInterruptionQueueName = "karpenter-interruption-queue";\nexport const karpenterInterruptionQueue = new aws.sqs.Queue(karpenterInterruptionQueueName, {\n\tnamePrefix: `${karpenterInterruptionQueueName}-`,\n\tmessageRetentionSeconds: 300,\n\tsqsManagedSseEnabled: true,\n\ttags: {\n\t\tName: karpenterInterruptionQueueName,\n\t\t"loliot.net/stack": variable.stackName,\n\t},\n});\n\nconst karpenterInterruptionQueuePolicyName = "karpenter-interruption-queue-policy";\nconst karpenterInterruptionQueuePolicy = new aws.sqs.QueuePolicy(karpenterInterruptionQueuePolicyName, {\n\tqueueUrl: karpenterInterruptionQueue.id,\n\tpolicy: {\n\t\tId: "EC2InterruptionPolicy",\n\t\tVersion: "2012-10-17",\n\t\tStatement: [\n\t\t\t{\n\t\t\t\tEffect: "Allow",\n\t\t\t\tPrincipal: {\n\t\t\t\t\tService: ["sqs.amazonaws.com", "events.amazonaws.com"],\n\t\t\t\t},\n\t\t\t\tAction: "sqs:SendMessage",\n\t\t\t\tResource: [karpenterInterruptionQueue.arn],\n\t\t\t},\n\t\t],\n\t},\n});\n'})}),"\n",(0,a.jsx)(t.h2,{id:"eventbridge-\ucd94\uac00",children:"EventBridge \ucd94\uac00"}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-ts",children:'const targetId = "KarpenterInterruptionQueueTarget";\n\nconst scheduledChangeRuleName = "scheduled-change-rule";\nconst scheduledChangeRule = new aws.cloudwatch.EventRule(scheduledChangeRuleName, {\n\tnamePrefix: `${scheduledChangeRuleName}-`,\n\teventPattern: JSON.stringify({\n\t\tsource: ["aws.health"],\n\t\t"detail-type": ["AWS Health Event"],\n\t}),\n\ttags: {\n\t\tName: scheduledChangeRuleName,\n\t\t"loliot.net/stack": variable.stackName,\n\t},\n});\n\nnew aws.cloudwatch.EventTarget(`${scheduledChangeRuleName}-target`, {\n\trule: scheduledChangeRule.name,\n\tarn: karpenterInterruptionQueue.arn,\n\ttargetId: targetId,\n});\n\nconst spotInterruptionRuleName = "spot-interruption-rule";\nconst spotInterruptionRule = new aws.cloudwatch.EventRule(spotInterruptionRuleName, {\n\tnamePrefix: `${spotInterruptionRuleName}-`,\n\teventPattern: JSON.stringify({\n\t\tsource: ["aws.ec2"],\n\t\t"detail-type": ["EC2 Spot Instance Interruption Warning"],\n\t}),\n\ttags: {\n\t\tName: spotInterruptionRuleName,\n\t\t"loliot.net/stack": variable.stackName,\n\t},\n});\n\nnew aws.cloudwatch.EventTarget(`${spotInterruptionRuleName}-target`, {\n\trule: spotInterruptionRule.name,\n\tarn: karpenterInterruptionQueue.arn,\n\ttargetId: targetId,\n});\n\nconst rebalanceRuleName = "rebalance-rule";\nconst rebalanceRule = new aws.cloudwatch.EventRule(rebalanceRuleName, {\n\tnamePrefix: `${rebalanceRuleName}-`,\n\teventPattern: JSON.stringify({\n\t\tsource: ["aws.ec2"],\n\t\t"detail-type": ["EC2 Instance Rebalance Recommendation"],\n\t}),\n\ttags: {\n\t\tName: rebalanceRuleName,\n\t\t"loliot.net/stack": variable.stackName,\n\t},\n});\n\nnew aws.cloudwatch.EventTarget(`${rebalanceRuleName}-target`, {\n\trule: rebalanceRule.name,\n\tarn: karpenterInterruptionQueue.arn,\n\ttargetId: targetId,\n});\n\nconst instanceStateChangeRuleName = "instance-state-change-rule";\nconst instanceStateChangeRule = new aws.cloudwatch.EventRule(instanceStateChangeRuleName, {\n\tnamePrefix: `${instanceStateChangeRuleName}-`,\n\teventPattern: JSON.stringify({\n\t\tsource: ["aws.ec2"],\n\t\t"detail-type": ["EC2 Instance State-change Notification"],\n\t}),\n\ttags: {\n\t\tName: instanceStateChangeRuleName,\n\t\t"loliot.net/stack": variable.stackName,\n\t},\n});\n\nnew aws.cloudwatch.EventTarget(`${instanceStateChangeRuleName}-target`, {\n\trule: instanceStateChangeRule.name,\n\tarn: karpenterInterruptionQueue.arn,\n\ttargetId: targetId,\n});\n'})}),"\n",(0,a.jsx)(t.h2,{id:"client",children:"Client"}),"\n",(0,a.jsxs)(t.p,{children:["\ud604\uc7ac v0.28.0 \ubc84\uc804\uc5d0\uc11c\ub294 ",(0,a.jsx)(t.code,{children:"EC2 Instance Rebalance Recommendation"})," \uc774\ubca4\ud2b8\ub97c \ucc98\ub9ac\ud558\uc9c0 \uc54a\uace0 \uc788\uc2b5\ub2c8\ub2e4. (",(0,a.jsx)(t.a,{href:"https://github.com/aws/karpenter/blob/bf484b63ae500578ac2843f28ba6ba6ab849d83f/pkg/controllers/interruption/controller.go#L288-L295",children:"https://github.com/aws/karpenter/blob/bf484b63ae500578ac2843f28ba6ba6ab849d83f/pkg/controllers/interruption/controller.go#L288-L295"}),")"]}),"\n",(0,a.jsx)(t.h3,{id:"karpenter-\uc124\uc815",children:"Karpenter \uc124\uc815"}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-ts",children:'const controllerPolicyName = "karpenter-controller-policy";\nconst controllerPolicy = new aws.iam.Policy(controllerPolicyName, {\n\tnamePrefix: `${controllerPolicyName}-`,\n\tpolicy: {\n\t\tVersion: "2012-10-17",\n\t\tStatement: [\n\t\t\t// ...\n\t\t\t{\n\t\t\t\tSid: "AllowInterruptionQueueActions",\n\t\t\t\tEffect: "Allow",\n\t\t\t\tResource: karpenterInterruptionQueue.arn,\n\t\t\t\tAction: ["sqs:DeleteMessage", "sqs:GetQueueAttributes", "sqs:GetQueueUrl", "sqs:ReceiveMessage"],\n\t\t\t},\n\t\t],\n\t},\n\t// ...\n});\n'})}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-yaml",metastring:'title="karpenter-values.yaml"',children:"settings:\n  interruptionQueue: <sqsName>\n"})}),"\n",(0,a.jsx)(t.h3,{id:"aws-node-termination-handler",children:"AWS Node Termination Handler"}),"\n",(0,a.jsxs)(t.ul,{children:["\n",(0,a.jsx)(t.li,{children:(0,a.jsx)(t.a,{href:"https://github.com/aws/aws-node-termination-handler",children:"https://github.com/aws/aws-node-termination-handler"})}),"\n"]})]})}function p(e={}){const{wrapper:t}={...(0,o.R)(),...e.components};return t?(0,a.jsx)(t,{...e,children:(0,a.jsx)(u,{...e})}):u(e)}},28453:(e,t,n)=>{n.d(t,{R:()=>s,x:()=>i});var r=n(96540);const a={},o=r.createContext(a);function s(e){const t=r.useContext(o);return r.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function i(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:s(e.components),r.createElement(o.Provider,{value:t},e.children)}}}]);