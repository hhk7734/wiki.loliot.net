"use strict";(self.webpackChunkwiki_loliot_net=self.webpackChunkwiki_loliot_net||[]).push([[97606],{20768:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>o,contentTitle:()=>c,default:()=>p,frontMatter:()=>i,metadata:()=>s,toc:()=>a});const s=JSON.parse('{"id":"mlops/mlops/aws/eks/eks","title":"EKS","description":"EKS","source":"@site/docs/mlops/mlops/aws/eks/eks.mdx","sourceDirName":"mlops/mlops/aws/eks","slug":"/mlops/mlops/aws/eks/","permalink":"/docs/mlops/mlops/aws/eks/","draft":false,"unlisted":false,"editUrl":"https://github.com/hhk7734/wiki/tree/main/docs/mlops/mlops/aws/eks/eks.mdx","tags":[],"version":"current","lastUpdatedAt":1721925757000,"frontMatter":{"id":"eks","title":"EKS","sidebar_label":"EKS","description":"EKS","keywords":["EKS"]},"sidebar":"mlops","previous":{"title":"VPC","permalink":"/docs/mlops/mlops/aws/vpc"},"next":{"title":"NodeGroup","permalink":"/docs/mlops/mlops/aws/eks/node-group"}}');var r=n(74848),l=n(28453);const i={id:"eks",title:"EKS",sidebar_label:"EKS",description:"EKS",keywords:["EKS"]},c=void 0,o={},a=[{value:"Create",id:"create",level:2},{value:"VPC &amp; Subnet",id:"vpc--subnet",level:3},{value:"Role",id:"role",level:3},{value:"Cluster",id:"cluster",level:3},{value:"OIDC",id:"oidc",level:3},{value:"VPC CNI increases pods per node limits",id:"vpc-cni-increases-pods-per-node-limits",level:3}];function d(e){const t={a:"a",admonition:"admonition",code:"code",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",ul:"ul",...(0,l.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(t.h2,{id:"create",children:"Create"}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.a,{href:"https://docs.aws.amazon.com/eks/latest/userguide/create-cluster.html",children:"https://docs.aws.amazon.com/eks/latest/userguide/create-cluster.html"})}),"\n"]}),"\n",(0,r.jsx)(t.h3,{id:"vpc--subnet",children:"VPC & Subnet"}),"\n",(0,r.jsxs)(t.p,{children:[(0,r.jsx)(t.code,{children:"kubernetes.io/cluster/<cluster-name>: <shared|owned>"})," \ud0dc\uadf8\ub97c \ucd94\uac00\ud574\uc8fc\uc138\uc694."]}),"\n",(0,r.jsx)(t.h3,{id:"role",children:"Role"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-ts",children:'const roleName = "eks-role";\nconst role = new aws.iam.Role(\n\troleName,\n\t{\n\t\tnamePrefix: `${roleName}-`,\n\t\tassumeRolePolicy: {\n\t\t\tVersion: "2012-10-17",\n\t\t\tStatement: [\n\t\t\t\t{\n\t\t\t\t\tEffect: "Allow",\n\t\t\t\t\tPrincipal: {\n\t\t\t\t\t\tService: "eks.amazonaws.com",\n\t\t\t\t\t},\n\t\t\t\t\tAction: "sts:AssumeRole",\n\t\t\t\t},\n\t\t\t],\n\t\t},\n\t\ttags: {\n\t\t\tName: roleName,\n\t\t\t"loliot.net/stack": variable.stackName,\n\t\t},\n\t},\n\t{ protect: true },\n);\n\nconst clusterPolicyARNs = {\n\t"0": "arn:aws:iam::aws:policy/AmazonEKSClusterPolicy",\n};\n\nconst rpas = Object.entries(clusterPolicyARNs).map(\n\t([i, arn]) =>\n\t\tnew aws.iam.RolePolicyAttachment(\n\t\t\t`eks-rpa-${i}`,\n\t\t\t{\n\t\t\t\tpolicyArn: arn,\n\t\t\t\trole: role.name,\n\t\t\t},\n\t\t\t{ protect: true },\n\t\t),\n);\n'})}),"\n",(0,r.jsx)(t.h3,{id:"cluster",children:"Cluster"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-ts",children:'const clusterName = "eks";\nexport const cluster = new aws.eks.Cluster(\n\tclusterName,\n\t{\n\t\tname: clusterName,\n\t\tversion: "1.28",\n\t\troleArn: role.arn,\n\t\tvpcConfig: {\n\t\t\tendpointPublicAccess: true,\n\t\t\tsubnetIds: [vpc.privateSubnet1.id, vpc.privateSubnet2.id, vpc.privateSubnet3.id, vpc.privateSubnet4.id],\n\t\t},\n\t\tkubernetesNetworkConfig: { serviceIpv4Cidr: "10.96.0.0/16" },\n\t\ttags: {\n\t\t\tName: clusterName,\n\t\t\t"loliot.net/stack": variable.stackName,\n\t\t},\n\t},\n\t{ dependsOn: [...rpas], protect: true },\n);\n'})}),"\n",(0,r.jsxs)(t.admonition,{type:"info",children:[(0,r.jsxs)(t.p,{children:["Cluster\ub97c \uc0dd\uc131\ud560 \ub54c \uc124\uc815\ud558\ub294 ",(0,r.jsx)(t.code,{children:"subnetIds"}),"\ub294 EKS \ub9c8\uc2a4\ud130\uc640 \uc6cc\ucee4\uac00 \ud1b5\uc2e0\ud558\uae30 \uc704\ud574 2~4 \uac1c\uc758 ENI\ub97c \ucd94\uac00\ud560 \uc11c\ube0c\ub137\uc744 \uc120\ud0dd\ud558\uae30 \uc704\ud55c \uc124\uc815\uc785\ub2c8\ub2e4. \ud574\ub2f9 ENI\uc758 \uc124\uba85\uc740 ",(0,r.jsx)(t.code,{children:"Amazon EKS <clusterName>"}),"\ub85c \ud45c\uc2dc\ub429\ub2c8\ub2e4."]}),(0,r.jsx)(t.p,{children:"\uc6cc\ucee4\uc640 \ud1b5\uc2e0\uc744 \uc704\ud574 \uc124\uc815\ud558\ub294 \uc11c\ube0c\ub137\uc77c \ubfd0, \uc6cc\ucee4\uac00 \ubc30\ud3ec\ub420 \uc11c\ube0c\ub137 \uc804\uccb4\ub97c \uc124\uc815\ud558\ub294 \uac83\uc740 \uc544\ub2d9\ub2c8\ub2e4."})]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-shell",children:"aws eks list-clusters\n"})}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-shell",children:"aws eks update-kubeconfig \\\n    --name <cluster-name> \\\n    --region <region> \\\n    --kubeconfig ~/.kube/<cluster-name>_config\n"})}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-shell",children:"export KUBECONFIG=<config-path>[:<config-path>]\n"})}),"\n",(0,r.jsx)(t.h3,{id:"oidc",children:"OIDC"}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.a,{href:"https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/enable-iam-roles-for-service-accounts.html",children:"https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/enable-iam-roles-for-service-accounts.html"})}),"\n"]}),"\n",(0,r.jsx)("br",{}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsxs)(t.li,{children:["EKS - \ud074\ub7ec\uc2a4\ud130 - \uac1c\uc694 - \uc138\ubd80 \uc815\ubcf4","\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsx)(t.li,{children:"OpenID Connect \uacf5\uae09\uc790 URL \ubcf5\uc0ac"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(t.li,{children:["IAM - \uc561\uc138\uc2a4 \uad00\ub9ac(Access management) - \uc790\uaca9 \uc99d\uba85 \uacf5\uae09\uc790(Identity Providers) - \uacf5\uae09\uc790 \ucd94\uac00","\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsx)(t.li,{children:"OpenID Connect"}),"\n",(0,r.jsx)(t.li,{children:"\uacf5\uae09\uc790 URL \ubd99\uc5ec\ub123\uae30"}),"\n",(0,r.jsx)(t.li,{children:"\uc9c0\ubb38 \uac00\uc838\uc624\uae30"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-ts",children:'const oidcProviderName = "eks-oidc-provider";\nexport const oidcProvider = new aws.iam.OpenIdConnectProvider(\n\toidcProviderName,\n\t{\n\t\turl: cluster.identities[0].oidcs[0].issuer,\n\t\tclientIdLists: ["sts.amazonaws.com"],\n\t\tthumbprintLists: ["**********"],\n\t\ttags: {\n\t\t\tName: oidcProviderName,\n\t\t\t"loliot.net/stack": variable.stackName,\n\t\t},\n\t},\n\t{ protect: true },\n);\n'})}),"\n",(0,r.jsx)(t.h3,{id:"vpc-cni-increases-pods-per-node-limits",children:"VPC CNI increases pods per node limits"}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.a,{href:"https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/cni-increase-ip-addresses.html",children:"https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/cni-increase-ip-addresses.html"})}),"\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.a,{href:"https://aws.amazon.com/ko/blogs/containers/amazon-vpc-cni-increases-pods-per-node-limits/",children:"https://aws.amazon.com/ko/blogs/containers/amazon-vpc-cni-increases-pods-per-node-limits/"})}),"\n"]}),"\n",(0,r.jsxs)(t.p,{children:[(0,r.jsx)(t.code,{children:"ENABLE_PREFIX_DELEGATION"}),"\ub97c \uc0ac\uc6a9\ud558\uba74 ENI\uc5d0 (/28) CIDR \ube14\ub85d\uc774 \ud560\ub2f9\ub429\ub2c8\ub2e4. Pod\uc774 \ud558\ub098\ub9cc \uc788\ub294 Node\uc5d0 (/28) CIDR \ube14\ub85d\uc774 2 \uac1c \ud560\ub2f9\ub418\uc5b4 \uc788\ub294 \uacbd\uc6b0, Node IP, Pod IP 2\uac1c\ub97c \uc81c\uc678\ud55c 30\uac1c\uc758 IP\ub294 \ub2e4\ub978 Node\uc5d0\uc11c \uc0ac\uc6a9\ud560 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4."]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-shell",children:"kubectl set env daemonset aws-node -n kube-system \\\n    ENABLE_PREFIX_DELEGATION=true\n"})}),"\n",(0,r.jsx)(t.admonition,{type:"warning",children:(0,r.jsxs)(t.p,{children:[(0,r.jsx)(t.code,{children:"pulumi"}),"\ub97c \uc0ac\uc6a9\ud560 \ub54c, NodeGroup \uc0dd\uc131 \uc804\uc5d0 \uc774 \uc791\uc5c5\uc744 \uc9c4\ud589\ud574\uc57c UserData\uc758 ",(0,r.jsx)(t.code,{children:"--kubelet-extra-args"}),"\uac00 \uc790\ub3d9\uc73c\ub85c \uc124\uc815\ub429\ub2c8\ub2e4."]})}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.a,{href:"https://github.com/aws/amazon-vpc-cni-k8s/blob/master/docs/prefix-and-ip-target.md",children:"https://github.com/aws/amazon-vpc-cni-k8s/blob/master/docs/prefix-and-ip-target.md"})}),"\n"]}),"\n",(0,r.jsxs)(t.p,{children:[(0,r.jsx)(t.code,{children:"WARM_PREFIX_TARGET=1"}),"\ub85c \uc124\uc815\ud55c \uacbd\uc6b0 \uc544\ubb34\uac83\ub3c4 \ud560\ub2f9\ub418\uc9c0 \uc54a\uc740 (/28) CIDR \ube14\ub85d 1 \uac1c\ub97c \uc720\uc9c0\ud558\ub3c4\ub85d \ub124\ud2b8\uc6cc\ud06c\uac00 \uad6c\uc131\ub429\ub2c8\ub2e4."]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-shell",children:"kubectl set env daemonset aws-node -n kube-system \\\n    WARM_PREFIX_TARGET=1\n"})}),"\n",(0,r.jsxs)(t.p,{children:["\ub0a8\ub294 IP\ub97c \ucd5c\uc18c\ud654 \ud558\uae30 \uc704\ud574\uc11c\ub294 ",(0,r.jsx)(t.code,{children:"WARM_PREFIX_TARGET=1"})," \ub300\uc2e0 ",(0,r.jsx)(t.code,{children:"WARM_IP_TARGET=1"}),", ",(0,r.jsx)(t.code,{children:"MINIMUM_IP_TARGET=1"}),"\uc744 \uc124\uc815\ud558\uba74 \ub429\ub2c8\ub2e4. \ub300\uc2e0 \ud560\ub2f9\ub41c IP\ub97c \ubaa8\ub450 \uc18c\uc9c4\ud55c \uc0c1\ud0dc\uc5d0\uc11c \uc0c8\ub85c\uc6b4 Pod\uc774 \ucd94\uac00\ub418\uba74 \uc0c8\ub85c\uc6b4 (/28) CIDR \ube14\ub85d\uc744 ENI\uc5d0 \ud560\ub2f9\ud55c \ud6c4 IP\ub97c \ud560\ub2f9\ud558\uae30 \ub54c\ubb38\uc5d0 Pod\uc774 \ub290\ub9ac\uac8c \ucf1c\uc9c0\ub294 \ubb38\uc81c\uac00 \uc788\uc73c\ub2c8 \uc8fc\uc758\ud574\uc57c\ud569\ub2c8\ub2e4."]})]})}function p(e={}){const{wrapper:t}={...(0,l.R)(),...e.components};return t?(0,r.jsx)(t,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},28453:(e,t,n)=>{n.d(t,{R:()=>i,x:()=>c});var s=n(96540);const r={},l=s.createContext(r);function i(e){const t=s.useContext(l);return s.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function c(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:i(e.components),s.createElement(l.Provider,{value:t},e.children)}}}]);