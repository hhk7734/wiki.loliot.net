"use strict";(self.webpackChunkwiki_loliot_net=self.webpackChunkwiki_loliot_net||[]).push([[18012],{11470:(e,n,t)=>{t.d(n,{A:()=>O});var o=t(96540),l=t(34164),r=t(23104),i=t(56347),a=t(205),s=t(57485),u=t(31682),d=t(70679);function c(e){return o.Children.toArray(e).filter((e=>"\n"!==e)).map((e=>{if(!e||(0,o.isValidElement)(e)&&function(e){const{props:n}=e;return!!n&&"object"==typeof n&&"value"in n}(e))return e;throw new Error(`Docusaurus error: Bad <Tabs> child <${"string"==typeof e.type?e.type:e.type.name}>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.`)}))?.filter(Boolean)??[]}function p(e){const{values:n,children:t}=e;return(0,o.useMemo)((()=>{const e=n??function(e){return c(e).map((e=>{let{props:{value:n,label:t,attributes:o,default:l}}=e;return{value:n,label:t,attributes:o,default:l}}))}(t);return function(e){const n=(0,u.XI)(e,((e,n)=>e.value===n.value));if(n.length>0)throw new Error(`Docusaurus error: Duplicate values "${n.map((e=>e.value)).join(", ")}" found in <Tabs>. Every value needs to be unique.`)}(e),e}),[n,t])}function h(e){let{value:n,tabValues:t}=e;return t.some((e=>e.value===n))}function v(e){let{queryString:n=!1,groupId:t}=e;const l=(0,i.W6)(),r=function(e){let{queryString:n=!1,groupId:t}=e;if("string"==typeof n)return n;if(!1===n)return null;if(!0===n&&!t)throw new Error('Docusaurus error: The <Tabs> component groupId prop is required if queryString=true, because this value is used as the search param name. You can also provide an explicit value such as queryString="my-search-param".');return t??null}({queryString:n,groupId:t});return[(0,s.aZ)(r),(0,o.useCallback)((e=>{if(!r)return;const n=new URLSearchParams(l.location.search);n.set(r,e),l.replace({...l.location,search:n.toString()})}),[r,l])]}function g(e){const{defaultValue:n,queryString:t=!1,groupId:l}=e,r=p(e),[i,s]=(0,o.useState)((()=>function(e){let{defaultValue:n,tabValues:t}=e;if(0===t.length)throw new Error("Docusaurus error: the <Tabs> component requires at least one <TabItem> children component");if(n){if(!h({value:n,tabValues:t}))throw new Error(`Docusaurus error: The <Tabs> has a defaultValue "${n}" but none of its children has the corresponding value. Available values are: ${t.map((e=>e.value)).join(", ")}. If you intend to show no default tab, use defaultValue={null} instead.`);return n}const o=t.find((e=>e.default))??t[0];if(!o)throw new Error("Unexpected error: 0 tabValues");return o.value}({defaultValue:n,tabValues:r}))),[u,c]=v({queryString:t,groupId:l}),[g,m]=function(e){let{groupId:n}=e;const t=function(e){return e?`docusaurus.tab.${e}`:null}(n),[l,r]=(0,d.Dv)(t);return[l,(0,o.useCallback)((e=>{t&&r.set(e)}),[t,r])]}({groupId:l}),y=(()=>{const e=u??g;return h({value:e,tabValues:r})?e:null})();(0,a.A)((()=>{y&&s(y)}),[y]);return{selectedValue:i,selectValue:(0,o.useCallback)((e=>{if(!h({value:e,tabValues:r}))throw new Error(`Can't select invalid tab value=${e}`);s(e),c(e),m(e)}),[c,m,r]),tabValues:r}}var m=t(92303);const y={tabList:"tabList__CuJ",tabItem:"tabItem_LNqP"};var f=t(74848);function b(e){let{className:n,block:t,selectedValue:o,selectValue:i,tabValues:a}=e;const s=[],{blockElementScrollPositionUntilNextRender:u}=(0,r.a_)(),d=e=>{const n=e.currentTarget,t=s.indexOf(n),l=a[t].value;l!==o&&(u(n),i(l))},c=e=>{let n=null;switch(e.key){case"Enter":d(e);break;case"ArrowRight":{const t=s.indexOf(e.currentTarget)+1;n=s[t]??s[0];break}case"ArrowLeft":{const t=s.indexOf(e.currentTarget)-1;n=s[t]??s[s.length-1];break}}n?.focus()};return(0,f.jsx)("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,l.A)("tabs",{"tabs--block":t},n),children:a.map((e=>{let{value:n,label:t,attributes:r}=e;return(0,f.jsx)("li",{role:"tab",tabIndex:o===n?0:-1,"aria-selected":o===n,ref:e=>{s.push(e)},onKeyDown:c,onClick:d,...r,className:(0,l.A)("tabs__item",y.tabItem,r?.className,{"tabs__item--active":o===n}),children:t??n},n)}))})}function _(e){let{lazy:n,children:t,selectedValue:r}=e;const i=(Array.isArray(t)?t:[t]).filter(Boolean);if(n){const e=i.find((e=>e.props.value===r));return e?(0,o.cloneElement)(e,{className:(0,l.A)("margin-top--md",e.props.className)}):null}return(0,f.jsx)("div",{className:"margin-top--md",children:i.map(((e,n)=>(0,o.cloneElement)(e,{key:n,hidden:e.props.value!==r})))})}function x(e){const n=g(e);return(0,f.jsxs)("div",{className:(0,l.A)("tabs-container",y.tabList),children:[(0,f.jsx)(b,{...n,...e}),(0,f.jsx)(_,{...n,...e})]})}function O(e){const n=(0,m.A)();return(0,f.jsx)(x,{...e,children:c(e.children)},String(n))}},19365:(e,n,t)=>{t.d(n,{A:()=>i});t(96540);var o=t(34164);const l={tabItem:"tabItem_Ymn6"};var r=t(74848);function i(e){let{children:n,hidden:t,className:i}=e;return(0,r.jsx)("div",{role:"tabpanel",className:(0,o.A)(l.tabItem,i),hidden:t,children:n})}},28453:(e,n,t)=>{t.d(n,{R:()=>i,x:()=>a});var o=t(96540);const l={},r=o.createContext(l);function i(e){const n=o.useContext(r);return o.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(l):e.components||l:i(e.components),o.createElement(r.Provider,{value:n},e.children)}},42234:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>d,contentTitle:()=>u,default:()=>h,frontMatter:()=>s,metadata:()=>o,toc:()=>c});const o=JSON.parse('{"id":"lang/python/libraries/yolov4/python-yolov4-edge-tpu","title":"YOLOv4 on Edge TPU","description":"YOLOv4 on Edge TPU","source":"@site/docs/lang/python/libraries/yolov4/python-yolov4-edge-tpu.mdx","sourceDirName":"lang/python/libraries/yolov4","slug":"/lang/python/libraries/yolov4/python-yolov4-edge-tpu","permalink":"/docs/lang/python/libraries/yolov4/python-yolov4-edge-tpu","draft":false,"unlisted":false,"editUrl":"https://github.com/hhk7734/wiki/tree/main/docs/lang/python/libraries/yolov4/python-yolov4-edge-tpu.mdx","tags":[],"version":"current","lastUpdatedAt":1740111436000,"frontMatter":{"id":"python-yolov4-edge-tpu","title":"YOLOv4 on Edge TPU","sidebar_label":"On Edge TPU","description":"YOLOv4 on Edge TPU","keywords":["Neural Network","YOLOv4","Coral","TPU"]},"sidebar":"python","previous":{"title":"mAP","permalink":"/docs/lang/python/libraries/yolov4/python-yolov4-map"},"next":{"title":"Backbone","permalink":"/docs/lang/python/libraries/yolov4/model/python-yolov4-model-backbone"}}');var l=t(74848),r=t(28453),i=t(11470),a=t(19365);const s={id:"python-yolov4-edge-tpu",title:"YOLOv4 on Edge TPU",sidebar_label:"On Edge TPU",description:"YOLOv4 on Edge TPU",keywords:["Neural Network","YOLOv4","Coral","TPU"]},u=void 0,d={},c=[{value:"Prepare int8 tflite",id:"prepare-int8-tflite",level:2},{value:"Training",id:"training",level:3},{value:"Convert to tflite",id:"convert-to-tflite",level:3},{value:"Run on Edge TPU",id:"run-on-edge-tpu",level:2},{value:"Install the Edge TPU runtime",id:"install-the-edge-tpu-runtime",level:3},{value:"Install just the TensorFlow Lite interpreter",id:"install-just-the-tensorflow-lite-interpreter",level:3},{value:"Run example script",id:"run-example-script",level:3}];function p(e){const n={a:"a",admonition:"admonition",code:"code",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(n.h2,{id:"prepare-int8-tflite",children:"Prepare int8 tflite"}),"\n",(0,l.jsxs)(n.p,{children:["Supported Operation: ",(0,l.jsx)(n.a,{href:"https://coral.ai/docs/edgetpu/models-intro/#supported-operations",children:"https://coral.ai/docs/edgetpu/models-intro/#supported-operations"})]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"Use YOLOv4-Tiny"})," because YOLOv4 model size is too large."]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"Use relu"})," for activation. YOLOv4-Tiny uses leaky-relu, but this is an ",(0,l.jsx)(n.strong,{children:"unsupported operation"})," on the Edge TPU."]}),"\n",(0,l.jsx)(n.li,{children:"Set the desired input_size before converting the model to tflite."}),"\n"]}),"\n",(0,l.jsx)(n.h3,{id:"training",children:"Training"}),"\n",(0,l.jsxs)(n.p,{children:["Ref: ",(0,l.jsx)(n.a,{href:"https://wiki.loliot.net/docs/lang/python/libraries/yolov4/python-yolov4-training#full-script",children:"https://wiki.loliot.net/docs/lang/python/libraries/yolov4/python-yolov4-training#full-script"})]}),"\n",(0,l.jsxs)(i.A,{groupId:"yolov4-version",defaultValue:"v3",values:[{label:"v3",value:"v3"},{label:"v2",value:"v2"}],children:[(0,l.jsx)(a.A,{value:"v3",children:(0,l.jsxs)(n.p,{children:["Use ",(0,l.jsx)(n.a,{href:"https://github.com/hhk7734/tensorflow-yolov4/tree/master/config",children:"yolov4-tiny-relu.cfg"})]})}),(0,l.jsx)(a.A,{value:"v2",children:(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-python",metastring:"{5,10}",children:'from tensorflow.keras import callbacks, optimizers\nfrom yolov4.tf import SaveWeightsCallback, YOLOv4\nimport time\n\nyolo = YOLOv4(tiny=True)\nyolo.classes = "/content/drive/My Drive/Hard_Soft/NN/coco/coco.names"\nyolo.input_size = 608\nyolo.batch_size = 32\n\nyolo.make_model(activation1="relu")\n\n...\n'})})})]}),"\n",(0,l.jsx)(n.h3,{id:"convert-to-tflite",children:"Convert to tflite"}),"\n",(0,l.jsxs)(i.A,{groupId:"yolov4-version",defaultValue:"v3",values:[{label:"v3",value:"v3"},{label:"v2",value:"v2"}],children:[(0,l.jsxs)(a.A,{value:"v3",children:[(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"2021-02-21"}),"\n",(0,l.jsx)(n.li,{children:"OS: Ubuntu 20.04"}),"\n",(0,l.jsx)(n.li,{children:"TF: v2.4.1"}),"\n",(0,l.jsx)(n.li,{children:"yolov4: v3.1.0"}),"\n"]}),(0,l.jsxs)(n.p,{children:["Use ",(0,l.jsx)(n.a,{href:"https://github.com/hhk7734/tensorflow-yolov4/tree/master/config",children:"yolov4-tiny-relu-tpu.cfg"})]}),(0,l.jsx)(n.admonition,{type:"danger",children:(0,l.jsxs)(n.p,{children:["Don't confuse ",(0,l.jsx)(n.code,{children:"yolov4-iny-relu.cfg"})," and ",(0,l.jsx)(n.code,{children:"yolov4-tiny-relu-tpu.cfg"})]})}),(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-python",children:'from yolov4.tf import YOLOv4, YOLODataset, save_as_tflite\n\nyolo = YOLOv4()\n\nyolo.config.parse_names("test/coco.names")\nyolo.config.parse_cfg("config/yolov4-tiny-relu-tpu.cfg")\n\nyolo.make_model()\nyolo.load_weights(\n    "/home/hhk7734/NN/yolov4-tiny-relu.weights", weights_type="yolo"\n)\n\ndataset = YOLODataset(\n    config=yolo.config,\n    dataset_list="/home/hhk7734/NN/val2017.txt",\n    image_path_prefix="/home/hhk7734/NN/val2017",\n    training=False,\n)\n\nsave_as_tflite(\n    model=yolo.model,\n    tflite_path="yolov4-tiny-relu-int8.tflite",\n    quantization="full_int8",\n    dataset=dataset,\n)\n'})}),(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-shell",metastring:"{1}",children:"$ edgetpu_compiler -sa yolov4-tiny-relu-int8.tflite\nEdge TPU Compiler version 15.0.340273435\n\nModel compiled successfully in 758 ms.\n\nInput model: yolov4-tiny-relu-int8.tflite\nInput size: 5.91MiB\nOutput model: yolov4-tiny-relu-int8_edgetpu.tflite\nOutput size: 5.98MiB\nOn-chip memory used for caching model parameters: 5.83MiB\nOn-chip memory remaining for caching model parameters: 1.78MiB\nOff-chip memory used for streaming uncached model parameters: 0.00B\nNumber of Edge TPU subgraphs: 2\nTotal number of operations: 51\nOperation log: yolov4-tiny-relu-int8_edgetpu.log\n\nModel successfully compiled but not all operations are supported by the Edge TPU. A percentage of the model will instead run on the CPU, which is slower. If possible, consider updating your model to use only operations supported by the Edge TPU. For details, visit g.co/coral/model-reqs.\nNumber of operations that will run on Edge TPU: 46\nNumber of operations that will run on CPU: 5\n\nOperator                       Count      Status\n\nRESIZE_BILINEAR                1          Operation version not supported\nDEQUANTIZE                     4          Operation is working on an unsupported data type\nCONV_2D                        21         Mapped to Edge TPU\nQUANTIZE                       8          Mapped to Edge TPU\nPAD                            2          Mapped to Edge TPU\nCONCATENATION                  7          Mapped to Edge TPU\nLOGISTIC                       2          Mapped to Edge TPU\nSPLIT                          3          Mapped to Edge TPU\nMAX_POOL_2D                    3          Mapped to Edge TPU\n"})}),(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-shell",children:"rsync yolov4-tiny-relu-int8_edgetpu.tflite coco.names yolov4-tiny-relu-tpu.cfg \\\n    mendel@<tpu ip>:~\n"})})]}),(0,l.jsxs)(a.A,{value:"v2",children:[(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-python",children:'from yolov4.tf import YOLOv4\n\nyolo = YOLOv4(tiny=True, tpu=True)\n\nyolo.classes = "coco.names"\nyolo.input_size = (512, 384) # width, height\nyolo.make_model(activation1="relu")\n\nyolo.load_weights("yolov4-tiny-relu.weights", weights_type="yolo")\n\ndataset = yolo.load_dataset(\n    "train2017.txt",\n    training=False,\n    image_path_prefix="/home/hhk7734/NN/train2017"\n)\n\nyolo.save_as_tflite(\n    "yolov4-tiny-relu-int8.tflite",\n    quantization="full_int8",\n    data_set=dataset,\n    num_calibration_steps=400\n)\n'})}),(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-shell",metastring:"{1}",children:"$ edgetpu_compiler -sa yolov4-tiny-relu-int8.tflite\nEdge TPU Compiler version 15.0.340273435\n\nModel compiled successfully in 1211 ms.\n\nInput model: yolov4-tiny-relu-int8.tflite\nInput size: 5.94MiB\nOutput model: yolov4-tiny-relu-int8_edgetpu.tflite\nOutput size: 6.33MiB\nOn-chip memory used for caching model parameters: 6.06MiB\nOn-chip memory remaining for caching model parameters: 1.66MiB\nOff-chip memory used for streaming uncached model parameters: 3.38KiB\nNumber of Edge TPU subgraphs: 3\nTotal number of operations: 132\nOperation log: yolov4-tiny-relu-int8_edgetpu.log\n\nModel successfully compiled but not all operations are supported by the Edge TPU. A percentage of the model will instead run on the CPU, which is slower. If possible, consider updating your model to use only operations supported by the Edge TPU. For details, visit g.co/coral/model-reqs.\nNumber of operations that will run on Edge TPU: 101\nNumber of operations that will run on CPU: 31\n\nOperator                       Count      Status\n\nPAD                            2          Mapped to Edge TPU\nSPLIT                          7          Mapped to Edge TPU\nADD                            6          Mapped to Edge TPU\nSUB                            6          Mapped to Edge TPU\nQUANTIZE                       27         Mapped to Edge TPU\nQUANTIZE                       6          Operation is otherwise supported, but not mapped due to some unspecified limitation\nDEQUANTIZE                     6          Operation is working on an unsupported data type\nEXP                            6          Operation is working on an unsupported data type\nCONCATENATION                  9          Mapped to Edge TPU\nMAX_POOL_2D                    3          Mapped to Edge TPU\nCONV_2D                        21         Mapped to Edge TPU\nLOGISTIC                       2          Mapped to Edge TPU\nMUL                            18         Mapped to Edge TPU\nRESIZE_BILINEAR                1          Operation version not supported\nSPLIT_V                        12         Operation not supported\n"})}),(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-shell",children:"rsync yolov4-tiny-relu-int8_edgetpu.tflite coco.names mendel@<tpu ip>:~\n"})})]})]}),"\n",(0,l.jsx)(n.h2,{id:"run-on-edge-tpu",children:"Run on Edge TPU"}),"\n",(0,l.jsx)(n.h3,{id:"install-the-edge-tpu-runtime",children:"Install the Edge TPU runtime"}),"\n",(0,l.jsxs)(n.p,{children:["Ref: ",(0,l.jsx)(n.a,{href:"https://coral.ai/docs/accelerator/get-started/#1-install-the-edge-tpu-runtime",children:"https://coral.ai/docs/accelerator/get-started/#1-install-the-edge-tpu-runtime"})]}),"\n",(0,l.jsx)(n.h3,{id:"install-just-the-tensorflow-lite-interpreter",children:"Install just the TensorFlow Lite interpreter"}),"\n",(0,l.jsxs)(n.p,{children:["Ref: ",(0,l.jsx)(n.a,{href:"https://www.tensorflow.org/lite/guide/python#install_just_the_tensorflow_lite_interpreter",children:"https://www.tensorflow.org/lite/guide/python#install_just_the_tensorflow_lite_interpreter"})]}),"\n",(0,l.jsx)(n.h3,{id:"run-example-script",children:"Run example script"}),"\n",(0,l.jsxs)(i.A,{groupId:"yolov4-version",defaultValue:"v3",values:[{label:"v3",value:"v3"},{label:"v2",value:"v2"}],children:[(0,l.jsx)(a.A,{value:"v3",children:(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-python",metastring:'title="edge_yolov4_tiny_video_test.py"',children:'import cv2\n\nfrom yolov4.tflite import YOLOv4\n\nyolo = YOLOv4()\n\nyolo.config.parse_names("coco.names")\nyolo.config.parse_cfg("yolov4-tiny-relu-tpu.cfg")\n\nyolo.summary()\n\nyolo.load_tflite("yolov4-tiny-relu-int8_edgetpu.tflite")\n\nyolo.inference(\n    "/dev/video1",\n    is_image=False,\n    cv_apiPreference=cv2.CAP_V4L2,\n    cv_frame_size=(640, 480),\n    cv_fourcc="YUYV",\n)\n'})})}),(0,l.jsx)(a.A,{value:"v2",children:(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-python",metastring:'title="edge_yolov4_tiny_video_test.py"',children:'from yolov4.tflite import YOLOv4\nimport cv2\n\nyolo = YOLOv4(tiny=True, tpu=True)\n\nyolo.classes = "coco.names"\n\nyolo.load_tflite("yolov4-tiny-relu-int8_edgetpu.tflite")\n\nyolo.inference(\n    "/dev/video1",\n    is_image=False,\n    cv_apiPreference=cv2.CAP_V4L2,\n    cv_frame_size=(640, 480),\n    cv_fourcc="YUYV",\n)\n'})})})]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-python",children:"python3 edge_yolov4_tiny_video_test.py\n"})})]})}function h(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,l.jsx)(n,{...e,children:(0,l.jsx)(p,{...e})}):p(e)}}}]);