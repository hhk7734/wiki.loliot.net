"use strict";(self.webpackChunkwiki_loliot_net=self.webpackChunkwiki_loliot_net||[]).push([[14927],{92318:(e,s,a)=>{a.r(s),a.d(s,{assets:()=>o,contentTitle:()=>r,default:()=>d,frontMatter:()=>l,metadata:()=>c,toc:()=>i});var n=a(74848),t=a(28453);const l={id:"cluster-autoscaler",title:"cluster-autoscaler",sidebar_label:"cluster-autoscaler",description:"cluster-autoscaler",keywords:["cluster-autoscaler"]},r=void 0,c={id:"mlops/mlops/aws/cluster-autoscaler",title:"cluster-autoscaler",description:"cluster-autoscaler",source:"@site/docs/mlops/mlops/aws/cluster-autoscaler.mdx",sourceDirName:"mlops/mlops/aws",slug:"/mlops/mlops/aws/cluster-autoscaler",permalink:"/docs/mlops/mlops/aws/cluster-autoscaler",draft:!1,unlisted:!1,tags:[],version:"current",lastUpdatedAt:1729871992e3,frontMatter:{id:"cluster-autoscaler",title:"cluster-autoscaler",sidebar_label:"cluster-autoscaler",description:"cluster-autoscaler",keywords:["cluster-autoscaler"]},sidebar:"mlops",previous:{title:"keycloak",permalink:"/docs/mlops/mlops/aws/eks/keycloak"},next:{title:"ECR",permalink:"/docs/mlops/mlops/aws/ecr"}},o={},i=[{value:"\uc0ac\uc804 \uc694\uad6c \uc0ac\ud56d",id:"\uc0ac\uc804-\uc694\uad6c-\uc0ac\ud56d",level:2},{value:"ASG(Auto Scaling Group)",id:"asgauto-scaling-group",level:3},{value:"managedNodeGroup",id:"managednodegroup",level:4},{value:"nodeGroup(self-managed)",id:"nodegroupself-managed",level:4},{value:"IAM",id:"iam",level:3},{value:"\uc124\uce58",id:"\uc124\uce58",level:2},{value:"IAM",id:"iam-1",level:3},{value:"AWS Credential(Optional)",id:"aws-credentialoptional",level:3},{value:"Troubleshooting",id:"troubleshooting",level:2},{value:"Reference",id:"reference",level:2}];function u(e){const s={a:"a",admonition:"admonition",code:"code",h2:"h2",h3:"h3",h4:"h4",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,t.R)(),...e.components};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(s.h2,{id:"\uc0ac\uc804-\uc694\uad6c-\uc0ac\ud56d",children:"\uc0ac\uc804 \uc694\uad6c \uc0ac\ud56d"}),"\n",(0,n.jsx)(s.h3,{id:"asgauto-scaling-group",children:"ASG(Auto Scaling Group)"}),"\n",(0,n.jsxs)(s.ul,{children:["\n",(0,n.jsxs)(s.li,{children:["Auto Scaling \uadf8\ub8f9\uc5d0 \uc544\ub798 \ud0dc\uadf8\uac00 \uc788\uc5b4\uc57c\ud569\ub2c8\ub2e4.","\n",(0,n.jsxs)(s.ul,{children:["\n",(0,n.jsxs)(s.li,{children:[(0,n.jsx)(s.code,{children:"kubernetes.io/cluster/<cluster-name>"}),": ",(0,n.jsx)(s.code,{children:"owned"})]}),"\n",(0,n.jsxs)(s.li,{children:[(0,n.jsx)(s.code,{children:"k8s.io/cluster-autoscaler/<cluster-name>"}),": ",(0,n.jsx)(s.code,{children:"owned"})]}),"\n",(0,n.jsxs)(s.li,{children:[(0,n.jsx)(s.code,{children:"k8s.io/cluster-autoscaler/enabled"}),": ",(0,n.jsx)(s.code,{children:"true"})]}),"\n"]}),"\n"]}),"\n",(0,n.jsxs)(s.li,{children:["\uc0ac\uc6a9\uc790 \ub370\uc774\ud130\ub97c \uc0ac\uc6a9\ud558\uc5ec ",(0,n.jsx)(s.strong,{children:"Control plane node"})," \uc5f0\uacb0, ",(0,n.jsx)(s.strong,{children:"node label"})," \uc124\uc815\uc744 \uc790\ub3d9\ud654 \ud574\uc90d\ub2c8\ub2e4."]}),"\n"]}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-shell",metastring:'title="eks-asg-example.sh"',children:'MIME-Version: 1.0\nContent-Type: multipart/mixed; boundary="//"\n\n--//\nContent-Type: text/x-shellscript; charset="us-ascii"\n#!/bin/bash\nset -ex\nB64_CLUSTER_CA=xxx\nAPI_SERVER_URL=xxx\nK8S_CLUSTER_DNS_IP=xxx\n/etc/eks/bootstrap.sh hhk-eks --kubelet-extra-args \'--node-labels=eks.amazonaws.com/sourceLaunchTemplateVersion=1,alpha.eksctl.io/cluster-name=hhk-eks,alpha.eksctl.io/nodegroup-name=worker-m5-large-ng,role=worker,eks.amazonaws.com/nodegroup-image=ami-0eb873de16468e55e,eks.amazonaws.com/capacityType=ON_DEMAND,eks.amazonaws.com/nodegroup=worker-m5-large-ng,eks.amazonaws.com/sourceLaunchTemplateId=lt-0676b3adb0ce8d3cc\' --b64-cluster-ca $B64_CLUSTER_CA --apiserver-endpoint $API_SERVER_URL --dns-cluster-ip $K8S_CLUSTER_DNS_IP\n\n--//--\n'})}),"\n",(0,n.jsx)(s.h4,{id:"managednodegroup",children:"managedNodeGroup"}),"\n",(0,n.jsxs)(s.ul,{children:["\n",(0,n.jsx)(s.li,{children:"EKS \ud074\ub7ec\uc2a4\ud130\uc758 \ub178\ub4dc \ud504\ub85c\ube44\uc800\ub2dd \ubc0f \uc218\uba85 \uc8fc\uae30 \uad00\ub9ac \uc790\ub3d9\ud654"}),"\n",(0,n.jsx)(s.li,{children:"AWS \uacc4\uc815\uc758 \ucd5c\uc2e0 Amazon EKS \ucd5c\uc801\ud654 AMI\ub97c \uc0ac\uc6a9\ud558\uc5ec \uc2e4\ud589"}),"\n",(0,n.jsx)(s.li,{children:"\ub178\ub4dc \uc5c5\ub370\uc774\ud2b8 \ubc0f \uc885\ub8cc\uc2dc \ub178\ub4dc\ub97c \uc801\uc808\ud558\uac8c \ube44\uc6cc \uc560\ud50c\ub9ac\ucf00\uc774\uc158\uc744 \uacc4\uc18d \uc0ac\uc6a9\ud560 \uc218 \uc788\ub3c4\ub85d \uad00\ub9ac"}),"\n"]}),"\n",(0,n.jsx)(s.h4,{id:"nodegroupself-managed",children:"nodeGroup(self-managed)"}),"\n",(0,n.jsx)(s.h3,{id:"iam",children:"IAM"}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-json",metastring:'title="cluster-autoscaler-policy.json"',children:'{\n\t"Version": "2012-10-17",\n\t"Statement": [\n\t\t{\n\t\t\t"Action": [\n\t\t\t\t"autoscaling:DescribeAutoScalingGroups",\n\t\t\t\t"autoscaling:DescribeAutoScalingInstances",\n\t\t\t\t"autoscaling:DescribeLaunchConfigurations",\n\t\t\t\t"autoscaling:DescribeTags",\n\t\t\t\t"autoscaling:SetDesiredCapacity",\n\t\t\t\t"autoscaling:TerminateInstanceInAutoScalingGroup",\n\t\t\t\t"ec2:DescribeLaunchTemplateVersions"\n\t\t\t],\n\t\t\t"Resource": "*",\n\t\t\t"Effect": "Allow"\n\t\t}\n\t]\n}\n'})}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-shell",children:"aws iam create-policy \\\n    --policy-name AmazonEKSClusterAutoscalerPolicy \\\n    --policy-document file://cluster-autoscaler-policy.json\n"})}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-shell",children:"eksctl create iamserviceaccount \\\n  --cluster=<my-cluster> \\\n  --namespace=kube-system \\\n  --name=cluster-autoscaler \\\n  --attach-policy-arn=arn:aws:iam::<AWS_ACCOUNT_ID>:policy/AmazonEKSClusterAutoscalerPolicy \\\n  --override-existing-serviceaccounts \\\n  --approve\n"})}),"\n",(0,n.jsx)(s.h2,{id:"\uc124\uce58",children:"\uc124\uce58"}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-shell",children:"mkdir -p aws-cluster-autoscaler/base/patches\n"})}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-shell",children:"wget https://raw.githubusercontent.com/kubernetes/autoscaler/master/cluster-autoscaler/cloudprovider/aws/examples/cluster-autoscaler-autodiscover.yaml \\\n    -O aws-cluster-autoscaler/base/cluster-autoscaler-autodiscover.yaml\n"})}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-yaml",metastring:'title="aws-cluster-autoscaler/base/cluster-autoscaler-autodiscover.yaml" {22,31,47,52}',children:'# ...\n---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: cluster-autoscaler\n  namespace: kube-system\n  labels:\n    app: cluster-autoscaler\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: cluster-autoscaler\n  template:\n    metadata:\n      labels:\n        app: cluster-autoscaler\n      annotations:\n        prometheus.io/scrape: "true"\n        prometheus.io/port: "8085"\n        cluster-autoscaler.kubernetes.io/safe-to-evict: "false"\n    spec:\n      priorityClassName: system-cluster-critical\n      securityContext:\n        runAsNonRoot: true\n        runAsUser: 65534\n        fsGroup: 65534\n      serviceAccountName: cluster-autoscaler\n      containers:\n        - image: k8s.gcr.io/autoscaling/cluster-autoscaler:v1.21.0\n          name: cluster-autoscaler\n          resources:\n            limits:\n              cpu: 100m\n              memory: 600Mi\n            requests:\n              memory: 600Mi\n          command:\n            - ./cluster-autoscaler\n            - --v=4\n            - --stderrthreshold=info\n            - --cloud-provider=aws\n            - --skip-nodes-with-local-storage=false\n            - --expander=least-waste\n            - --node-group-auto-discovery=asg:tag=k8s.io/cluster-autoscaler/enabled,k8s.io/cluster-autoscaler/<cluster-name>\n            - --balance-similar-node-groups\n            - --skip-nodes-with-system-pods=false\n          volumeMounts:\n            - name: ssl-certs\n              mountPath: /etc/ssl/certs/ca-certificates.crt # /etc/ssl/certs/ca-bundle.crt for Amazon Linux Worker Nodes\n              readOnly: true\n          imagePullPolicy: "Always"\n      volumes:\n        - name: ssl-certs\n          hostPath:\n            path: "/etc/ssl/certs/ca-bundle.crt"\n'})}),"\n",(0,n.jsxs)(s.ul,{children:["\n",(0,n.jsxs)(s.li,{children:[(0,n.jsx)(s.code,{children:"cluster-autoscaler.kubernetes.io/safe-to-evict: 'false'"}),": \uc81c\uac70 \ube44\uc6a9\uc774 \ub9ce\uc774 \ub4dc\ub294 pod\ub77c\ub294 \ud45c\uc2dc\ub85c, \ud574\ub2f9 pod\uc774 node\uc5d0 \uc788\ub294 \uacbd\uc6b0 node\ub294 scalie in \ub418\uc9c0 \uc54a\uc2b5\ub2c8\ub2e4."]}),"\n"]}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-shell",metastring:'title=" aws-cluster-autoscaler/base/kustomization.yaml"',children:"apiVersion: kustomize.config.k8s.io/v1beta1\nkind: Kustomization\nresources:\n  - cluster-autoscaler-autodiscover.yaml\n"})}),"\n",(0,n.jsx)(s.h3,{id:"iam-1",children:"IAM"}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-shell",children:"mkdir -p aws-cluster-autoscaler/overlays/iam/patches\n"})}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-yaml",metastring:'{4} title="aws-cluster-autoscaler/overlays/iam/patches/role.yaml"',children:"- op: add\n  path: /metadata/annotations\n  value:\n    eks.amazonaws.com/role-arn: arn:aws:iam::<ACCOUNT_ID>:role/<AmazonEKSClusterAutoscalerRole>\n"})}),"\n",(0,n.jsx)(s.admonition,{type:"warning",children:(0,n.jsxs)(s.p,{children:[(0,n.jsx)(s.code,{children:"AmazonEKSClusterAutoscalerPolicy"})," policy\ub97c \uc801\uc6a9\ud55c role\uc758 ARN\uc744 \uc124\uc815\ud574\uc57c\ud569\ub2c8\ub2e4."]})}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-yaml",metastring:'title="aws-cluster-autoscaler/overlays/iam/kustomization.yaml"',children:"apiVersion: kustomize.config.k8s.io/v1beta1\nkind: Kustomization\nresources:\n  - ../../base\n\npatches:\n  - path: patches/role.yaml\n    target:\n      kind: ServiceAccount\n"})}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-shell",children:"kubectl apply -k aws-cluster-autoscaler/overlays/iam\n"})}),"\n",(0,n.jsx)(s.h3,{id:"aws-credentialoptional",children:"AWS Credential(Optional)"}),"\n",(0,n.jsx)(s.admonition,{type:"warning",children:(0,n.jsx)(s.p,{children:"On-premise \ud658\uacbd\uc5d0\uc11c \uc0ac\uc6a9\ud558\ub294 \uacbd\uc6b0 \uc544\ub798\uc640 \uac19\uc740 \uc778\uc99d \ubc29\uc2dd\uc744 \uc0ac\uc6a9\ud560 \uc218 \uc788\uc2b5\ub2c8\ub2e4. (\ubcf4\uc548 \uc704\ud611 \uc694\uc18c\uac00 \ub420 \uc218 \uc788\uc74c)"})}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-shell",children:"mkdir -p aws-cluster-autoscaler/overlays/credentials/patches\n"})}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-yaml",metastring:'{8-9} title="aws-cluster-autoscaler/overlays/credentials/credentials.yaml"',children:"apiVersion: v1\nkind: Secret\nmetadata:\n  name: aws-secret\n  namespace: kube-system\ntype: Opaque\ndata:\n  aws_access_key_id: <BASE64_OF_YOUR_AWS_ACCESS_KEY_ID>\n  aws_secret_access_key: <BASE64_OF_YOUR_AWS_SECRET_ACCESS_KEY>\n"})}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-yaml",metastring:'{15} title="aws-cluster-autoscaler/overlays/credentials/patches/env.yaml"',children:"- op: add\n  path: /spec/template/spec/containers/0/env\n  value:\n    - name: AWS_ACCESS_KEY_ID\n      valueFrom:\n        secretKeyRef:\n          name: aws-secret\n          key: aws_access_key_id\n    - name: AWS_SECRET_ACCESS_KEY\n      valueFrom:\n        secretKeyRef:\n          name: aws-secret\n          key: aws_secret_access_key\n    - name: AWS_REGION\n      value: <REGION>\n"})}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-yaml",metastring:'title="aws-cluster-autoscaler/overlays/credentials/kustomization.yaml"',children:"apiVersion: kustomize.config.k8s.io/v1beta1\nkind: Kustomization\nresources:\n  - credentials.yaml\n  - ../../base\n\npatches:\n  - path: patches/env.yaml\n    target:\n      kind: Deployment\n"})}),"\n",(0,n.jsx)(s.h2,{id:"troubleshooting",children:"Troubleshooting"}),"\n",(0,n.jsx)(s.pre,{children:(0,n.jsx)(s.code,{className:"language-shell",children:"kubectl logs -n kube-system -f deployment.apps/cluster-autoscaler\n"})}),"\n",(0,n.jsx)(s.h2,{id:"reference",children:"Reference"}),"\n",(0,n.jsxs)(s.ul,{children:["\n",(0,n.jsx)(s.li,{children:(0,n.jsx)(s.a,{href:"https://docs.aws.amazon.com/eks/latest/userguide/cluster-autoscaler.html",children:"https://docs.aws.amazon.com/eks/latest/userguide/cluster-autoscaler.html"})}),"\n",(0,n.jsx)(s.li,{children:(0,n.jsx)(s.a,{href:"https://github.com/kubernetes/autoscaler/tree/master/cluster-autoscaler/cloudprovider/aws",children:"https://github.com/kubernetes/autoscaler/tree/master/cluster-autoscaler/cloudprovider/aws"})}),"\n",(0,n.jsx)(s.li,{children:(0,n.jsx)(s.a,{href:"https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/enable-iam-roles-for-service-accounts.html",children:"https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/enable-iam-roles-for-service-accounts.html"})}),"\n"]})]})}function d(e={}){const{wrapper:s}={...(0,t.R)(),...e.components};return s?(0,n.jsx)(s,{...e,children:(0,n.jsx)(u,{...e})}):u(e)}},28453:(e,s,a)=>{a.d(s,{R:()=>r,x:()=>c});var n=a(96540);const t={},l=n.createContext(t);function r(e){const s=n.useContext(l);return n.useMemo((function(){return"function"==typeof e?e(s):{...s,...e}}),[s,e])}function c(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:r(e.components),n.createElement(l.Provider,{value:s},e.children)}}}]);