"use strict";(self.webpackChunkwiki_loliot_net=self.webpackChunkwiki_loliot_net||[]).push([[11153],{28453:(e,n,r)=>{r.d(n,{R:()=>t,x:()=>l});var o=r(96540);const c={},i=o.createContext(c);function t(e){const n=o.useContext(i);return o.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(c):e.components||c:t(e.components),o.createElement(i.Provider,{value:n},e.children)}},54890:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>s,contentTitle:()=>a,default:()=>u,frontMatter:()=>l,metadata:()=>o,toc:()=>d});const o=JSON.parse('{"id":"mlops/nn/llm/mooncake","title":"Mooncake (2407) - A KVCache-centric Disaggregated Architecture for LLM Serving","description":"Mooncake (2407) - A KVCache-centric Disaggregated Architecture for LLM Serving","source":"@site/docs/mlops/nn/llm/mooncake.mdx","sourceDirName":"mlops/nn/llm","slug":"/mlops/nn/llm/mooncake","permalink":"/docs/mlops/nn/llm/mooncake","draft":false,"unlisted":false,"editUrl":"https://github.com/hhk7734/wiki/tree/main/docs/mlops/nn/llm/mooncake.mdx","tags":[],"version":"current","lastUpdatedAt":1769968109000,"frontMatter":{"id":"mooncake","title":"Mooncake (2407) - A KVCache-centric Disaggregated Architecture for LLM Serving","sidebar_label":"Mooncake (2407)","description":"Mooncake (2407) - A KVCache-centric Disaggregated Architecture for LLM Serving","keywords":["Neural Network","Large Language Model","Mooncake"]},"sidebar":"nn","previous":{"title":"KV Cache","permalink":"/docs/mlops/nn/llm/kvcache"},"next":{"title":"DeepSeek-V3 (2412)","permalink":"/docs/mlops/nn/llm/deepseek-v3"}}');var c=r(74848),i=r(28453),t=r(98180);const l={id:"mooncake",title:"Mooncake (2407) - A KVCache-centric Disaggregated Architecture for LLM Serving",sidebar_label:"Mooncake (2407)",description:"Mooncake (2407) - A KVCache-centric Disaggregated Architecture for LLM Serving",keywords:["Neural Network","Large Language Model","Mooncake"]},a=void 0,s={},d=[{value:"Introduction",id:"introduction",level:2},{value:"Overview of Mooncake&#39;s Disaggregated Architecture",id:"overview-of-mooncakes-disaggregated-architecture",level:2},{value:"KVCache-centric Scheduling",id:"kvcache-centric-scheduling",level:2},{value:"Sampled Real-wrold Request Trace",id:"sampled-real-wrold-request-trace",level:2}];function h(e){const n={a:"a",admonition:"admonition",h2:"h2",li:"li",mermaid:"mermaid",p:"p",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,c.jsxs)(c.Fragment,{children:[(0,c.jsx)(n.admonition,{title:"References",type:"info",children:(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsx)(n.li,{children:(0,c.jsx)(n.a,{href:"https://arxiv.org/abs/2407.00079",children:"Mooncake: A KVCache-centric Disaggregated Architecture for LLM Serving"})}),"\n"]})}),"\n",(0,c.jsx)(n.h2,{id:"introduction",children:"Introduction"}),"\n",(0,c.jsx)("figure",{children:(0,c.jsxs)("center",{children:[(0,c.jsx)("img",{src:(0,t.Ay)("img/mlops/nn/llm/mooncake.png")}),(0,c.jsx)("br",{}),(0,c.jsx)("figcaption",{children:(0,c.jsx)(n.a,{href:"https://arxiv.org/html/2407.00079v3",children:"Figure 1: Mooncake Architecture."})})]})}),"\n",(0,c.jsx)(n.p,{children:"Mooncake\ub294 \ub2e4\uc74c Service Level Objectives (SLOs)\ub97c \uace0\ub824\ud558\uc5ec \ub514\uc790\uc778\ub418\uc5c8\uc2b5\ub2c8\ub2e4."}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsx)(n.li,{children:"Time To First Token (TTFT)"}),"\n",(0,c.jsx)(n.li,{children:"Time Between Tokens (TBT) == Inter-Token Latency (ITL)"}),"\n"]}),"\n",(0,c.jsx)(n.p,{children:"\uc774\ub97c \ub9cc\uc871\uc2dc\ud0a4\uae30 \uc704\ud574"}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsx)(n.li,{children:"Prefill Pool\uc740 KV cache\ub97c \ucd5c\ub300\ud55c \uc7ac\ud65c\uc6a9\ud558\uc5ec \uac01 \uc694\uccad\uc5d0 \ub300\ud55c \ucef4\ud4e8\ud305 \uc2dc\uac04\uc744 \ub2e8\ucd95\ud574\uc57c \ud569\ub2c8\ub2e4."}),"\n",(0,c.jsx)(n.li,{children:"Decode Pool\uc740 \uac01 \ubc30\uce58\uc758 \ud1a0\ud070 \uc218\ub97c \ucd5c\ub300\ud55c \ub298\ub824\uc11c Model FLOPs Utilization (MFU)\ub97c \ub192\uc5ec\uc57c \ud569\ub2c8\ub2e4."}),"\n"]}),"\n",(0,c.jsxs)(n.p,{children:[(0,c.jsx)(n.strong,{children:"Conductor"}),"\ub294 \uc774 \ubd84\uc0b0\ub41c \ucef4\ud3ec\ub10c\ud2b8\ub4e4\uc744 \uc870\uc728\ud558\ub294 \uae00\ub85c\ubc8c \uc2a4\ucf00\uc904\ub7ec\uc785\ub2c8\ub2e4."]}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.strong,{children:"Request Dispatching"}),": \ud604\uc7ac KVCache\uc640 \uc6cc\ud06c\ub85c\ub4dc\uc758 \ubd84\ud3ec\ub97c \uae30\ubc18\uc73c\ub85c prefill/decode \uc778\uc2a4\ud134\uc2a4 \uc30d\uc744 \uc120\ud0dd\ud558\uc5ec \uc694\uccad\uc744 \ubd84\ubc30\ud569\ub2c8\ub2e4."]}),"\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.strong,{children:"KVCache Management"}),": KVCache \ube14\ub85d\uc758 \ubbf8\ub798 \uc0ac\uc6a9\ub7c9\uc744 \uc608\uce21\ud558\uc5ec \ubcf5\uc81c(replicate) \ubc0f \uc2a4\uc651(swap)\uc744 \uc218\ud589\ud569\ub2c8\ub2e4. \uac00\uc7a5 \uc790\uc8fc \uc0ac\uc6a9\ub418\ub294 \ube14\ub85d(hottest)\uc740 \ud63c\uc7a1\uc744 \ud53c\ud558\uae30 \uc704\ud574 \uc5ec\ub7ec \ub178\ub4dc\uc5d0 \ubcf5\uc81c\ud558\uace0, \ub35c \uc0ac\uc6a9\ub418\ub294 \ube14\ub85d(coldest)\uc740 \ube44\uc6a9 \uc808\uac10\uc744 \uc704\ud574 swap out \ud569\ub2c8\ub2e4."]}),"\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.strong,{children:"Overload Handling"}),": \uc2dc\uc2a4\ud15c \ubd80\ud558\uac00 \ub192\uc744 \ub54c, prefill \ub2e8\uacc4\ub97c \ub9c8\uce5c \ud6c4 \ub514\ucf54\ub529 \uc2ac\ub86f\uc774 \uc5c6\uc744 \uac83\uc73c\ub85c \uc608\uc0c1\ub418\uba74 \ub0ad\ube44\ub97c \ub9c9\uae30 \uc704\ud574 \uc694\uccad\uc744 \uc870\uae30 \uac70\uc808(early rejection)\ud558\ub294 \uc5ed\ud560\ub3c4 \uc218\ud589\ud569\ub2c8\ub2e4."]}),"\n"]}),"\n",(0,c.jsx)(n.h2,{id:"overview-of-mooncakes-disaggregated-architecture",children:"Overview of Mooncake's Disaggregated Architecture"}),"\n",(0,c.jsx)("figure",{children:(0,c.jsxs)("center",{children:[(0,c.jsx)("img",{src:(0,t.Ay)("img/mlops/nn/llm/mooncake-kv-cache-pool.png")}),(0,c.jsx)("br",{}),(0,c.jsx)("figcaption",{children:(0,c.jsx)(n.a,{href:"https://arxiv.org/html/2407.00079v3",children:"Figure 3: The KVCache pool in CPU memory."})})]})}),"\n",(0,c.jsx)("figure",{children:(0,c.jsxs)("center",{children:[(0,c.jsx)("img",{src:(0,t.Ay)("img/mlops/nn/llm/mooncake-kv-cache-transfer.png")}),(0,c.jsx)("br",{}),(0,c.jsx)("figcaption",{children:(0,c.jsx)(n.a,{href:"https://arxiv.org/html/2407.00079v3",children:"Figure 4: Workflow of inference instances."})})]})}),"\n",(0,c.jsx)(n.p,{children:"Mooncake\ub294 GPU HBM, CPU DRAM, RDMA \ub4f1\uc758 \ub9ac\uc18c\uc2a4\ub97c \ud65c\uc6a9\ud558\uc5ec KV cache\ub97c \uad00\ub9ac\ud569\ub2c8\ub2e4."}),"\n",(0,c.jsx)(n.p,{children:"CPU DRAM\uc758 KV cache pool\uc740"}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsxs)(n.li,{children:["cache\ub97c paged block \ud615\ud0dc\ub85c \uc800\uc7a5\ud569\ub2c8\ub2e4.","\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsx)(n.li,{children:"\uac01 block\uc740 512 \uac1c\uc758 \ud1a0\ud070\uc744 \uc800\uc7a5\ud560 \uc218 \uc788\uc2b5\ub2c8\ub2e4."}),"\n",(0,c.jsx)(n.li,{children:"\uac01 block\uc740 \uc790\uae30 \uc790\uc2e0\uacfc \uc774\uc804 block\uc5d0 \ub300\ud55c hash \uac12\uc744 \uac00\uc9c0\uace0 \uc788\uc2b5\ub2c8\ub2e4."}),"\n"]}),"\n"]}),"\n",(0,c.jsx)(n.li,{children:"Least Recently Used (LRU), Least Frequently Used (LFU) \ub4f1 \uc694\uccad \ud328\ud134\uc5d0 \ub530\ub77c block\uc744 \ucd95\ucd9c\ud569\ub2c8\ub2e4."}),"\n",(0,c.jsx)(n.li,{children:"GPU \uc5f0\uc0b0\uacfc KV cache pool \uad00\ub9ac\ub294 \ubcd1\ub82c\ub85c \uc218\ud589\ub429\ub2c8\ub2e4."}),"\n"]}),"\n",(0,c.jsx)(n.h2,{id:"kvcache-centric-scheduling",children:"KVCache-centric Scheduling"}),"\n",(0,c.jsx)(n.p,{children:"Mooncake\ub294 \ub2e8\uc21c\ud788 \ubd80\ud558 \ubd84\uc0b0(load balancing)\uc744 \ud558\ub294 \uac83\uc744 \ub118\uc5b4\uc11c, prefix cache aware \uc640 load aware \uc2a4\ucf00\uc904\ub9c1\uc744 \uc218\ud589\ud569\ub2c8\ub2e4."}),"\n",(0,c.jsx)(n.mermaid,{value:"sequenceDiagram\n  autonumber\n\n  participant Client\n  participant Conductor\n  participant Pools\n\n  box rgba(40, 25, 25, 0.5) Prefiller\n    participant Prefiller\n    participant P_Pool\n  end\n\n  box rgba(20, 25, 40, 0.5) Decoder\n    participant Decoder\n    participant D_Pool\n  end\n\n  Client ->> Conductor: Request\n  Conductor ->> Conductor: Calculate Prefix Hashes / Block IDs\n  Conductor ->> Conductor: Query Global Prefix Tree (Locality)\n\n  rect rgba(35, 70, 45, 0.5)\n    Note over Conductor: Algorithm 1 Cost Estimation\n    Conductor ->> Conductor: Estimate Prefill Queue wait\n    Conductor ->> Conductor: Estimate Prefill TTFT\n    Conductor ->> Conductor: Estimate Transfer Latency\n    Conductor ->> Conductor: Estimate Decode ITL\n    Conductor ->> Conductor: Select Instance Pair\n  end\n\n  alt SLO Violation\n    Conductor --\x3e> Client: Early Rejection\n  end\n\n  alt Proactive Retrieval\n    Conductor ->> P_Pool: Migrate Hot-spot\n    P_Pool ->> Pools: Fetch Prefix Cache\n    Pools --\x3e> P_Pool: KV cache\n  end\n\n  Conductor ->> Prefiller: Tokens + Metadata\n  Conductor ->> Decoder: Reserve Decoding Slot\n\n  Prefiller ->> P_Pool: Fetch Prefix Cache\n\n  P_Pool --\x3e> Prefiller: KV cache\n\n  Prefiller ->> Prefiller: Prefill\n\n  par Stream KV Cache\n    Prefiller ->> P_Pool: Send KV Cache\n    P_Pool ->> D_Pool: Send KV Cache\n  end\n\n  Prefiller --\x3e> Conductor: Response\n\n  rect rgba(35, 70, 45, 0.5)\n    Conductor ->> Conductor: Estimate Decode ITL\n  end\n  alt SLO Violation\n    Conductor --\x3e> Client: Early Rejection\n  end\n\n  Conductor ->> Decoder: Tokens + Metadata\n  Decoder ->> D_Pool: Fetch Prefix Cache\n  D_Pool --\x3e> Decoder: KV cache\n  loop\n    Decoder ->> Client: Stream Generated Token\n  end"}),"\n",(0,c.jsx)(n.h2,{id:"sampled-real-wrold-request-trace",children:"Sampled Real-wrold Request Trace"}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsx)(n.li,{children:"Input Sequence Length (ISL)\uc758 \ud3c9\uade0\uc740 7590 \uc774\uc600\uc2b5\ub2c8\ub2e4."}),"\n",(0,c.jsx)(n.li,{children:"Output Sequence Length (OSL)\uc758 \ud3c9\uade0\uc740 182 \uc600\uc2b5\ub2c8\ub2e4."}),"\n",(0,c.jsx)(n.li,{children:"KV cache \uc6a9\ub7c9\uc744 1000 blocks\uc5d0\uc11c 50000 blocks\ub85c \uc62c\ub838\uc744 \ub54c cache hit ratio\ub294 30%\uc5d0\uc11c 50%\ub85c \uc99d\uac00\ud588\uc2b5\ub2c8\ub2e4."}),"\n",(0,c.jsx)(n.li,{children:"\uadf8 \uc774\uc0c1 \uc6a9\ub7c9\uc744 \ub298\ub9ac\ub294 \uacbd\uc6b0 \uc601\ud5a5\uc740 \ubbf8\ubbf8\ud588\uc9c0\ub9cc \uc0d8\ud50c\ub9c1 \ub41c \uacb0\uacfc\uc774\ubbc0\ub85c \uc6a9\ub7c9\uc740 \ud06c\uba74 \ud074 \uc218\ub85d cache hit ratio\uac00 \uc99d\uac00\ud560 \uac00\ub2a5\uc131\uc774 \uc788\uc2b5\ub2c8\ub2e4."}),"\n",(0,c.jsx)(n.li,{children:"\ud2b9\uc815 block\ub4e4\uc740 \uc218\ub9cc \ubc88 \uc7ac\uc0ac\uc6a9\ub418\ub294 \ubc18\uba74, 50%\uc758 block\uc774 \uac70\uc758 \uc7ac\uc0ac\uc6a9\ub418\uc9c0 \uc54a\uc558\uc2b5\ub2c8\ub2e4."}),"\n"]})]})}function u(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,c.jsx)(n,{...e,children:(0,c.jsx)(h,{...e})}):h(e)}}}]);