"use strict";(self.webpackChunkwiki_loliot_net=self.webpackChunkwiki_loliot_net||[]).push([[28161],{28453:(e,n,c)=>{c.d(n,{R:()=>t,x:()=>i});var l=c(96540);const r={},o=l.createContext(r);function t(e){const n=l.useContext(o);return l.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function i(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:t(e.components),l.createElement(o.Provider,{value:n},e.children)}},45588:(e,n,c)=>{c.r(n),c.d(n,{assets:()=>a,contentTitle:()=>i,default:()=>h,frontMatter:()=>t,metadata:()=>l,toc:()=>d});const l=JSON.parse('{"id":"mlops/serving/llm/vllm/kvcache","title":"vLLM KVCache \ubd84\uc11d","description":"vLLM KVCache \ubd84\uc11d","source":"@site/docs/mlops/serving/llm/vllm/kvcache.mdx","sourceDirName":"mlops/serving/llm/vllm","slug":"/mlops/serving/llm/vllm/kvcache","permalink":"/docs/mlops/serving/llm/vllm/kvcache","draft":false,"unlisted":false,"editUrl":"https://github.com/hhk7734/wiki/tree/main/docs/mlops/serving/llm/vllm/kvcache.mdx","tags":[],"version":"current","lastUpdatedAt":1763138773000,"frontMatter":{"id":"kvcache","title":"vLLM KVCache \ubd84\uc11d","sidebar_label":"KVCache \ubd84\uc11d","description":"vLLM KVCache \ubd84\uc11d","keywords":["vLLM","KVCache"]},"sidebar":"serving","previous":{"title":"vLLM \uc124\uc815 \uac00\uc774\ub4dc","permalink":"/docs/mlops/serving/llm/vllm/"},"next":{"title":"inference-perf","permalink":"/docs/mlops/serving/llm/benchmark/inference-perf"}}');var r=c(74848),o=c(28453);const t={id:"kvcache",title:"vLLM KVCache \ubd84\uc11d",sidebar_label:"KVCache \ubd84\uc11d",description:"vLLM KVCache \ubd84\uc11d",keywords:["vLLM","KVCache"]},i=void 0,a={},d=[{value:"vLLM \uc124\uc815",id:"vllm-\uc124\uc815",level:2},{value:"KVConnectorBase_V1",id:"kvconnectorbase_v1",level:2},{value:"Worker",id:"worker",level:3},{value:"Prefill",id:"prefill",level:2}];function s(e){const n={a:"a",admonition:"admonition",code:"code",h2:"h2",h3:"h3",li:"li",mermaid:"mermaid",p:"p",ul:"ul",...(0,o.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.h2,{id:"vllm-\uc124\uc815",children:"vLLM \uc124\uc815"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\ud658\uacbd \ubcc0\uc218","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"PYTHONHASHSEED=<int>"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\uccab \ubc88\uc9f8 \uc694\uccad\uc758 \ubd80\ubaa8 hash \uac12\uc744 \ub9cc\ub4e4 \ub54c \uc0ac\uc6a9\ub429\ub2c8\ub2e4."}),"\n",(0,r.jsx)(n.li,{children:"\uc124\uc815\ud558\uc9c0 \uc54a\uc73c\uba74 \ub79c\ub364 \uac12\uc774 \uc124\uc815\ub418\uc5b4 cache hit\ub97c \uacc4\uc0b0\ud560 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4."}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["Scheduler","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"--enable-chunked-prefill"})}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["Cache","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"--enable-prefix-caching"})}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"--block-size <size>"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"1, 8, 16, 32, 64, 128 \uc911\uc5d0 \uc120\ud0dd\ud560 \uc218 \uc788\uc2b5\ub2c8\ub2e4."}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"--prefix-caching-hash-algo builtin"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"hash \uc54c\uace0\ub9ac\uc998\uc744 \uc9c0\uc815\ud569\ub2c8\ub2e4."}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"builtin"}),": python ",(0,r.jsx)(n.code,{children:"hash"})," \ud568\uc218\ub97c \uc0ac\uc6a9\ud569\ub2c8\ub2e4."]}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"sha256"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"sha256_cbor_64bit"})}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["vLLM","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"--kv-events-config <configJson>"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"KVEvent publisher\ub97c \uc704\ud55c \uc124\uc815\uc785\ub2c8\ub2e4."}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"enable_kv_cache_events: true"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"publisher: zmq"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"endpoint: tcp://<host>:<port>"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"topic: <topic>"})}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:'--kv-transfer-config \'{"<option>": "<value>", ...}\''}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"<option>"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"kv_connector: <KVConnectorBaseV1Impl>"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"KVConnector \uad6c\ud604\uccb4\ub97c \uc9c0\uc815\ud569\ub2c8\ub2e4."}),"\n",(0,r.jsxs)(n.li,{children:["e.g. ",(0,r.jsx)(n.code,{children:"NixlConnector"}),", ",(0,r.jsx)(n.code,{children:"MultiConnector"})]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"kv_role: <role>"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"kv_producer"}),", ",(0,r.jsx)(n.code,{children:"kv_consumer"}),", ",(0,r.jsx)(n.code,{children:"kv_both"})," \uc911 \ud558\ub098\ub97c \uc9c0\uc815\ud569\ub2c8\ub2e4."]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"kv_connector_module_path: <module>"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"vllm\uc5d0 \ud3ec\ud568\ub418\uc9c0 \uc54a\uc740 KVConnector \uad6c\ud604\uccb4\ub97c \uc0ac\uc6a9\ud560 \uacbd\uc6b0, \ud574\ub2f9 \ubaa8\ub4c8\uc758 \uacbd\ub85c\ub97c \uc9c0\uc815\ud569\ub2c8\ub2e4."}),"\n",(0,r.jsxs)(n.li,{children:["e.g. ",(0,r.jsx)(n.code,{children:"lmcache.integration.vllm.lmcache_connector_v1"})]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"kvconnectorbase_v1",children:"KVConnectorBase_V1"}),"\n",(0,r.jsx)(n.admonition,{title:"References",type:"info",children:(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://github.com/vllm-project/vllm/pull/15960",children:"vLLM GitHub / PR #15960"})}),"\n"]})}),"\n",(0,r.jsx)(n.p,{children:"\ud558\ub098\uc758 vLLM\uc740 \uc544\ub798\uc640 \uac19\uc774 \uad6c\uc131\ub418\uc5b4 \uc788\uc2b5\ub2c8\ub2e4."}),"\n",(0,r.jsx)(n.mermaid,{value:"flowchart\n  subgraph Scheduler[Scheduler process]\n    KVConnectorS[KVConnector<br/>in Scheduler]\n  end\n\n  subgraph Worker1[Worker process]\n    KVConnectorW1[KVConnector<br/>in Worker]\n  end\n\n  subgraph Worker2[Worker process]\n    KVConnectorW2[KVConnector<br/>in Worker]\n  end\n\n  Scheduler --\x3e Worker1\n  Scheduler --\x3e Worker2"}),"\n",(0,r.jsx)(n.h3,{id:"worker",children:"Worker"}),"\n",(0,r.jsx)(n.mermaid,{value:"sequenceDiagram\n  participant Scheduler\n  participant ModelRunner\n  participant Attention\n  participant KVConnector\n\n  Scheduler ->> KVConnector: get_num_new_matched_tokens()\n  KVConnector --\x3e> Scheduler: num_external_computed_tokens\n\n  Scheduler ->> KVConnector: update_state_after_alloc()\n\n  ModelRunner ->> ModelRunner: set_forward_context()\n  activate ModelRunner\n\n  ModelRunner ->> KVConnector: bind_connector_metadata()\n  activate ModelRunner\n\n  ModelRunner ->> KVConnector: start_load_kv()\n  activate KVConnector\n  KVConnector --\x3e> ModelRunner: KVConnectorOutput\n\n  ModelRunner ->> Attention: forward()\n  activate Attention\n  loop for each layer\n    Attention ->> KVConnector: wait_for_layer_load()\n    deactivate KVConnector\n    Attention ->> Attention: forward()\n    Attention ->> KVConnector: save_kv_layer()\n    activate KVConnector\n  end\n  deactivate Attention\n\n  ModelRunner ->> KVConnector: wait_for_save()\n  deactivate KVConnector\n\n  ModelRunner ->> KVConnector: get_finished()\n\n  ModelRunner ->> KVConnector: clear_connector_metadata()\n  deactivate ModelRunner\n\n  ModelRunner --\x3e> ModelRunner: end set_forward_context()\n  deactivate ModelRunner"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"start_load_kv()"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\ubd88\ub7ec\uc62c KVCache\uac00 \uc788\ub294 \uacbd\uc6b0 KVCache\ub97c \ubd88\ub7ec\uc624\uae30 \uc2dc\uc791\ud569\ub2c8\ub2e4."}),"\n",(0,r.jsxs)(n.li,{children:["\ub450 \uac00\uc9c0 \uad6c\ud604\ubc29\uc2dd\uc774 \uc788\uc2b5\ub2c8\ub2e4.","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\ud55c \ubc88\uc5d0 \ubaa8\ub4e0 layer\uc758 KVCache\ub97c \ubd88\ub7ec\uc624\uae30"}),"\n",(0,r.jsxs)(n.li,{children:["\ube44\ub3d9\uae30\uc801\uc73c\ub85c \ubd88\ub7ec\uc624\uba74\uc11c ",(0,r.jsx)(n.code,{children:"wait_for_layer_load()"}),"\ub97c \ud1b5\ud574 \uac01 layer\uac00 \uc2e4\ud589\ub418\uae30 \uc804\uc5d0 \uc644\ub8cc\ub420 \ub54c\uae4c\uc9c0 \ub300\uae30"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"wait_for_layer_load()"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\ud574\ub2f9 layer\uc758 KVCache\uac00 \ubd88\ub7ec\uc640\uc84c\ub294\uc9c0 \ud655\uc778\ud569\ub2c8\ub2e4."}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"start_load_kv()"}),"\uc5d0\uc11c \ubaa8\ub4e0 layer\uc758 KVCache\ub97c \ubd88\ub7ec\uc624\ub294 \uad6c\ud604\uc778 \uacbd\uc6b0, \uad6c\ud604\ud558\uc9c0 \uc54a\uc544\ub3c4 \ub429\ub2c8\ub2e4."]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"save_kv_layer()"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\ud574\ub2f9 layer\uc758 KVCache\ub97c \uc800\uc7a5\ud569\ub2c8\ub2e4."}),"\n",(0,r.jsxs)(n.li,{children:["\uc624\ud504\ub85c\ub529\ud558\uc9c0 \uc54a\uac70\ub098 ",(0,r.jsx)(n.code,{children:"wait_for_save()"}),"\uc5d0\uc11c \ud55c \ubc88\uc5d0 \ubaa8\ub4e0 layer\ub97c \uc800\uc7a5\ud558\ub294 \uad6c\ud604\uc778 \uacbd\uc6b0, \uad6c\ud604\ud558\uc9c0 \uc54a\uc544\ub3c4 \ub429\ub2c8\ub2e4."]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"wait_for_save()"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\ubaa8\ub4e0 layer\uc758 KVCache\uac00 \uc800\uc7a5\ub420 \ub54c\uae4c\uc9c0 \ub300\uae30\ud569\ub2c8\ub2e4."}),"\n",(0,r.jsx)(n.li,{children:"\uc624\ud504\ub85c\ub529\ud558\uc9c0 \uc54a\ub294 \uacbd\uc6b0, \uad6c\ud604\ud558\uc9c0 \uc54a\uc544\ub3c4 \ub429\ub2c8\ub2e4."}),"\n",(0,r.jsxs)(n.li,{children:["\uad6c\ud604\ud558\ub294 \uacbd\uc6b0 \ub450 \uac00\uc9c0 \uad6c\ud604\ubc29\uc2dd\uc774 \uc788\uc2b5\ub2c8\ub2e4.","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"save_kv_layer()"})," \ud638\ucd9c \uc2dc \ube44\ub3d9\uae30\uc801\uc73c\ub85c \uc800\uc7a5\ud558\uae30 \uc2dc\uc791\ud558\uace0 \ubaa8\ub4e0 layer\uac00 \uc800\uc7a5\ub420 \ub54c\uae4c\uc9c0 \ub300\uae30"]}),"\n",(0,r.jsx)(n.li,{children:"\ud55c \ubc88\uc5d0 \ubaa8\ub4e0 layer\uc758 KVCache\ub97c \uc800\uc7a5\ud558\uae30"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"prefill",children:"Prefill"}),"\n",(0,r.jsx)(n.admonition,{type:"warning",children:(0,r.jsx)(n.p,{children:"\ud638\ucd9c\ud558\uc9c0\ub9cc KVCache \ud750\ub984\uc5d0 \uc601\ud5a5\uc744 \ubbf8\uce58\uc9c0 \uc54a\ub294 \ud568\uc218\ub4e4\uc740 \ud45c\uc2dc\ud558\uc9c0 \uc54a\uc558\uc2b5\ub2c8\ub2e4. \ud544\uc694 \uc5c6\ub294 \ubd80\ubd84\uc744 \uc0dd\ub7b5\ud558\ub294 \uacfc\uc815\uc5d0\uc11c \uc21c\uc11c \ud30c\uc545\uc774 \uc798\ubabb\ub418\uc5c8\uc744 \uc218 \uc788\uc2b5\ub2c8\ub2e4."})}),"\n",(0,r.jsx)(n.p,{children:"\uac00\uc815\uc740 \uc544\ub798\uc640 \uac19\uc2b5\ub2c8\ub2e4."}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"LMCacheConnector\ub97c \uc0ac\uc6a9\ud569\ub2c8\ub2e4."}),"\n",(0,r.jsx)(n.li,{children:"NixlConnector\ub97c \uc0ac\uc6a9\ud569\ub2c8\ub2e4."}),"\n",(0,r.jsx)(n.li,{children:"prefix cache\ub97c \uc0ac\uc6a9\ud569\ub2c8\ub2e4."}),"\n"]}),"\n",(0,r.jsx)(n.mermaid,{value:"sequenceDiagram\n  box rgba(130, 90, 50, 0.5) Prefill\n    participant EngineCore\n    participant Scheduler\n    participant KVCacheManager\n    participant KVCacheCoordinator\n    participant SingleTypeKVCacheManager\n    participant BlockPool\n    participant Executor\n    participant ModelRunner\n    participant Attention\n    participant EventPublisher\n    participant MultiConnector\n    participant LMCacheConnector\n    participant NixlConnector\n  end\n\n  box rgba(50, 90, 130, 0.5) Decode\n    participant D_NixlConnector as NixlConnector\n  end\n\n  EngineCore ->> Scheduler: schedule()\n  Scheduler ->> KVCacheManager: get_computed_blocks()\n  KVCacheManager ->> KVCacheCoordinator: find_longest_cache_hit()\n  KVCacheCoordinator ->> SingleTypeKVCacheManager: find_longest_cache_hit()\n  SingleTypeKVCacheManager ->> BlockPool: get_cached_block()\n  BlockPool --\x3e> SingleTypeKVCacheManager: cached_blocks\n  SingleTypeKVCacheManager --\x3e> KVCacheCoordinator: cached_blocks\n  KVCacheCoordinator --\x3e> KVCacheManager: cached_blocks, num_local_cached_tokens\n  KVCacheManager --\x3e> Scheduler: cached_blocks, num_local_cached_tokens\n\n  Scheduler ->> MultiConnector: get_num_new_matched_tokens()\n  MultiConnector ->> LMCacheConnector: get_num_new_matched_tokens()\n  LMCacheConnector --\x3e> MultiConnector: num_external_cached_tokens\n  MultiConnector --\x3e> Scheduler: num_external_cached_tokens\n\n  Scheduler ->> Scheduler: num_new_tokens\n\n  Scheduler ->> KVCacheManager: allocate_slots()\n  KVCacheManager ->> KVCacheCoordinator: allocate_new_blocks()\n  KVCacheCoordinator ->> SingleTypeKVCacheManager: allocate_new_blocks()\n  SingleTypeKVCacheManager ->> BlockPool: get_new_blocks()\n  BlockPool ->> BlockPool: events.append(BlockRemoved())\n  BlockPool --\x3e> SingleTypeKVCacheManager: new_blocks\n  SingleTypeKVCacheManager --\x3e> KVCacheCoordinator: new_blocks\n  KVCacheCoordinator --\x3e> KVCacheManager: new_blocks\n  KVCacheManager --\x3e> Scheduler: new_blocks\n\n  Scheduler ->> MultiConnector: update_state_after_alloc()\n  MultiConnector ->> LMCacheConnector: update_state_after_alloc()\n\n  Scheduler ->> MultiConnector: build_connector_meta()\n  MultiConnector ->> LMCacheConnector: build_connector_meta()\n  LMCacheConnector --\x3e> MultiConnector: connector_metadata\n  MultiConnector --\x3e> Scheduler: connector_metadata\n\n  Scheduler ->> KVCacheManager: take_events()\n  KVCacheManager ->> BlockPool: take_events()\n  BlockPool --\x3e> KVCacheManager: events\n  KVCacheManager --\x3e> Scheduler: events\n\n  Scheduler ->> EventPublisher: publish_events()\n  Scheduler ->> EngineCore: schedule_output\n\n  EngineCore ->> Executor: execute_model()\n  Executor ->> ModelRunner: execute_model()\n  ModelRunner ->> ModelRunner: set_forward_context()\n  activate ModelRunner\n  ModelRunner ->> MultiConnector: bind_connector_metadata()\n  activate ModelRunner\n  ModelRunner ->> MultiConnector: start_load_kv()\n  MultiConnector ->> LMCacheConnector: start_load_kv()\n  MultiConnector --\x3e> ModelRunner: connector_output\n  ModelRunner ->> Attention: forward()\n  Attention --\x3e> ModelRunner: model_output\n  ModelRunner ->> MultiConnector: wait_for_save()\n  MultiConnector ->> LMCacheConnector: wait_for_save()\n  ModelRunner ->> MultiConnector: get_finished()\n  MultiConnector ->> NixlConnector: get_finished()\n  D_NixlConnector ->> NixlConnector: read()\n  NixlConnector --\x3e> D_NixlConnector: kv_cache\n  NixlConnector --\x3e> MultiConnector: finished_output\n  MultiConnector --\x3e> ModelRunner: finished_output\n  ModelRunner ->> MultiConnector: clear_connector_metadata()\n  deactivate ModelRunner\n  ModelRunner ->> ModelRunner: end set_forward_context()\n  deactivate ModelRunner\n  ModelRunner --\x3e> Executor: model_output\n  Executor --\x3e> EngineCore: model_output\n\n  EngineCore ->> Scheduler: update_from_output()\n  Scheduler ->> MultiConnector: request_finished()\n  MultiConnector ->> NixlConnector: request_finished()\n  NixlConnector --\x3e> MultiConnector: delay_free_blocks, kv_xfer_params\n  MultiConnector --\x3e> Scheduler: delay_free_blocks, kv_xfer_params\n  Scheduler ->> KVCacheManager: free()\n  KVCacheManager ->> KVCacheCoordinator: free()\n  KVCacheCoordinator ->> SingleTypeKVCacheManager: free()\n  SingleTypeKVCacheManager ->> BlockPool: free_blocks()\n\n  EngineCore ->> Scheduler: schedule()\n  Scheduler ->> KVCacheManager: allocate_slots()\n  KVCacheManager ->> KVCacheCoordinator: cache_blocks()\n  KVCacheCoordinator ->> SingleTypeKVCacheManager: cache_blocks()\n  SingleTypeKVCacheManager ->> BlockPool: cache_full_blocks()\n  BlockPool ->> BlockPool: queue.append(BlockStored())\n\n  Scheduler ->> KVCacheManager: take_events()\n  KVCacheManager ->> BlockPool: take_events()\n  BlockPool --\x3e> KVCacheManager: events\n  KVCacheManager --\x3e> Scheduler: events\n\n  Scheduler ->> EventPublisher: publish_events()\n  Scheduler ->> EngineCore: schedule_output"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"update_state_after_alloc()"}),": request, blocks(",(0,r.jsx)(n.code,{children:"cached_blocks + new_blocks"}),"), num_external_cached_tokens\uc774 KVConnector\uc5d0 \uc804\ub2ec\ub429\ub2c8\ub2e4."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"num_new_tokens"}),": ",(0,r.jsx)(n.code,{children:"num_input_tokens - num_local_cached_tokens - num_external_cached_tokens"})]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"free_blocks()"}),": block.ref_cnt\uac00 0\uc778 \uacbd\uc6b0 free_block_queue\uc5d0 \ucd94\uac00\ud569\ub2c8\ub2e4."]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(s,{...e})}):s(e)}}}]);