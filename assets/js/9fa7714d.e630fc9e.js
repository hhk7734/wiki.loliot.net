"use strict";(self.webpackChunkwiki_loliot_net=self.webpackChunkwiki_loliot_net||[]).push([[21154],{4794:(n,e,t)=>{t.r(e),t.d(e,{assets:()=>i,contentTitle:()=>a,default:()=>p,frontMatter:()=>c,metadata:()=>s,toc:()=>l});const s=JSON.parse('{"id":"lang/python/context/contextvar","title":"contextvar","description":"contextvar","source":"@site/docs/lang/python/context/contextvar.mdx","sourceDirName":"lang/python/context","slug":"/lang/python/context/contextvar","permalink":"/docs/lang/python/context/contextvar","draft":false,"unlisted":false,"editUrl":"https://github.com/hhk7734/wiki/tree/main/docs/lang/python/context/contextvar.mdx","tags":[],"version":"current","lastUpdatedAt":1732196727000,"frontMatter":{"id":"contextvar","title":"contextvar","sidebar_label":"contextvar","description":"contextvar","keywords":["contextvar"]},"sidebar":"python","previous":{"title":"asyncio","permalink":"/docs/lang/python/asyncio/"},"next":{"title":"Convert bytes to ctypes.Structure","permalink":"/docs/lang/python/libraries/ctypes/python-ctypes-convert-bytes-structure"}}');var o=t(74848),r=t(28453);const c={id:"contextvar",title:"contextvar",sidebar_label:"contextvar",description:"contextvar",keywords:["contextvar"]},a=void 0,i={},l=[{value:"<code>contextvars.ContextVar</code>",id:"contextvarscontextvar",level:2},{value:"<code>contextlib.contextmanager</code>\uc640 \ud568\uaed8 \uc0ac\uc6a9\ud558\uae30",id:"contextlibcontextmanager\uc640-\ud568\uaed8-\uc0ac\uc6a9\ud558\uae30",level:2}];function d(n){const e={code:"code",h2:"h2",li:"li",p:"p",pre:"pre",ul:"ul",...(0,r.R)(),...n.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(e.h2,{id:"contextvarscontextvar",children:(0,o.jsx)(e.code,{children:"contextvars.ContextVar"})}),"\n",(0,o.jsx)(e.p,{children:"\ud30c\ub77c\ubbf8\ud130\ub97c \ud1b5\ud574 \ud568\uc218\ub97c \ud638\ucd9c\ud574\uac00\uba70 \uac12\uc744 \uc804\ub2ec\ud560 \ub54c, \uccab \ubc88\uc9f8 \uc778\uc790\ub97c \uc804\ub2ec\ud55c \ud568\uc218\ub85c\ubd80\ud130"}),"\n",(0,o.jsxs)(e.ul,{children:["\n",(0,o.jsx)(e.li,{children:"\ucf5c \uc2a4\ud0dd\uc774 \uae4a\uc5b4\uc9c8 \uc218\ub85d"}),"\n",(0,o.jsx)(e.li,{children:"\ud30c\ub77c\ubbf8\ud130 \uc218\uac00 \ub298\uc5b4\ub0a0 \uc218\ub85d"}),"\n"]}),"\n",(0,o.jsx)(e.p,{children:"\ud568\uc218\uc758 \uc2dc\uadf8\ub2c8\ucc98\uac00 \uae38\uc5b4\uc9c0\uace0, \ud30c\ub77c\ubbf8\ud130\uc758 \uc218\uc815\uc774 \uc5b4\ub824\uc6cc\uc9d1\ub2c8\ub2e4."}),"\n",(0,o.jsx)(e.p,{children:"\uc774\ub97c \uc804\uc5ed\ubcc0\uc218\ub85c \ud574\uacb0\ud558\ub824\uace0 \ud558\uba74 \uba40\ud2f0 \uc2a4\ub808\ub4dc \ud658\uacbd\uc5d0\uc11c \ubb38\uc81c\uac00 \ubc1c\uc0dd\ud569\ub2c8\ub2e4."}),"\n",(0,o.jsx)(e.pre,{children:(0,o.jsx)(e.code,{className:"language-python",children:'import random\nimport time\nfrom concurrent.futures import ThreadPoolExecutor\n\nnum_step = 0\n\n\ndef step(n: int) -> None:\n    if n == 3:\n        return\n\n    global num_step\n    s = num_step\n    print(f"n: {n}, s: {s}")\n\n    time.sleep(random.random() * 2)\n\n    token = num_step\n    num_step += 1\n    try:\n        step(n + 1)\n    finally:\n        num_step = token\n\n    s = num_step\n    print(f"n: {n}, s: {s}")\n\n\nwith ThreadPoolExecutor(max_workers=3) as executor:\n    executor.map(step, [0] * 3)\n'})}),"\n",(0,o.jsx)(e.pre,{children:(0,o.jsx)(e.code,{className:"language-shell",children:"n: 0, s: 0\nn: 0, s: 0\nn: 0, s: 0\nn: 1, s: 1\nn: 1, s: 2\nn: 1, s: 3\nn: 2, s: 4\nn: 2, s: 5\nn: 2, s: 6\nn: 2, s: 6\nn: 1, s: 3\nn: 0, s: 2\nn: 2, s: 2\nn: 1, s: 4\nn: 0, s: 0\nn: 2, s: 0\nn: 1, s: 5\nn: 0, s: 1\n"})}),"\n",(0,o.jsxs)(e.p,{children:["\uc704 \ucf54\ub4dc\uc5d0\uc11c \ub2e8\uc21c\ud788 ",(0,o.jsx)(e.code,{children:"step(0)"}),"\uc744 \ud638\ucd9c\ud55c\ub2e4\uba74 ",(0,o.jsx)(e.code,{children:"n"}),"\uacfc ",(0,o.jsx)(e.code,{children:"s"}),"\uac00 \uac19\uc740 \uac12\uc774 \ucd9c\ub825\ub418\uc9c0\ub9cc, \uba40\ud2f0 \uc2a4\ub808\ub4dc\ub85c \uc2e4\ud589\ud558\uba74 \uc2e4\ud589 \uc21c\uc11c\uc5d0 \ub530\ub77c ",(0,o.jsx)(e.code,{children:"n"}),"\uacfc ",(0,o.jsx)(e.code,{children:"s"}),"\uac00 \ub2e4\ub978 \uac12\uc774 \ucd9c\ub825\ub429\ub2c8\ub2e4."]}),"\n",(0,o.jsxs)(e.p,{children:["\uc774\ub97c \ud574\uacb0\ud558\uae30\uc704\ud574 ",(0,o.jsx)(e.code,{children:"contextvars.ContextVar"}),"\ub97c \uc0ac\uc6a9\ud558\uba74 \uc544\ub798\uc640 \uac19\uc774 \uac01 \ud568\uc218 \ud638\ucd9c\uc740 \ub3c5\ub9bd\uc801\uc778 \ucee8\ud0dd\uc2a4\ud2b8\uc5d0\uc11c \uc2e4\ud589\ub418\uae30 \ub54c\ubb38\uc5d0 \ubb38\uc81c\uac00 \ubc1c\uc0dd\ud558\uc9c0 \uc54a\uc2b5\ub2c8\ub2e4."]}),"\n",(0,o.jsx)(e.pre,{children:(0,o.jsx)(e.code,{className:"language-python",children:'import random\nimport time\nfrom concurrent.futures import ThreadPoolExecutor\nfrom contextvars import ContextVar\n\nnum_step = ContextVar[int]("num_step", default=0)\n\n\ndef step(n: int) -> None:\n    if n == 3:\n        return\n\n    s = num_step.get()\n    print(f"n: {n}, s: {s}")\n\n    time.sleep(random.random() * 2)\n\n    token = num_step.set(s + 1)\n    try:\n        step(n + 1)\n    finally:\n        num_step.reset(token)\n\n    s = num_step.get()\n    print(f"n: {n}, s: {s}")\n\n\nwith ThreadPoolExecutor(max_workers=3) as executor:\n    executor.map(step, [0] * 3)\n'})}),"\n",(0,o.jsx)(e.pre,{children:(0,o.jsx)(e.code,{className:"language-shell",children:"n: 0, s: 0\nn: 0, s: 0\nn: 0, s: 0\nn: 1, s: 1\nn: 1, s: 1\nn: 2, s: 2\nn: 1, s: 1\nn: 2, s: 2\nn: 2, s: 2\nn: 2, s: 2\nn: 1, s: 1\nn: 0, s: 0\nn: 2, s: 2\nn: 1, s: 1\nn: 0, s: 0\nn: 2, s: 2\nn: 1, s: 1\nn: 0, s: 0\n"})}),"\n",(0,o.jsx)(e.p,{children:"\ub9c8\ucc2c\uac00\uc9c0\ub85c asyncio\uc5d0\uc11c\ub3c4 \uc0ac\uc6a9\ud560 \uc218 \uc788\uc2b5\ub2c8\ub2e4."}),"\n",(0,o.jsx)(e.pre,{children:(0,o.jsx)(e.code,{className:"language-python",children:'import asyncio\nimport random\nfrom contextvars import ContextVar\n\nnum_step = ContextVar[int]("num_step", default=0)\n\n\nasync def step(n: int) -> None:\n    if n == 3:\n        return\n\n    s = num_step.get()\n    print(f"n: {n}, s: {s}")\n\n    await asyncio.sleep(random.random() * 2)\n\n    token = num_step.set(s + 1)\n    try:\n        await step(n + 1)\n    finally:\n        num_step.reset(token)\n\n    s = num_step.get()\n    print(f"n: {n}, s: {s}")\n\n\nasync def main() -> None:\n    cos = [step(0) for _ in range(3)]\n    await asyncio.gather(*cos)\n\n\nasyncio.run(main())\n'})}),"\n",(0,o.jsxs)(e.h2,{id:"contextlibcontextmanager\uc640-\ud568\uaed8-\uc0ac\uc6a9\ud558\uae30",children:[(0,o.jsx)(e.code,{children:"contextlib.contextmanager"}),"\uc640 \ud568\uaed8 \uc0ac\uc6a9\ud558\uae30"]}),"\n",(0,o.jsx)(e.p,{children:"\ucee8\ud0dd\uc2a4\ud2b8 \ubcc0\uc218\ub294 \uac12\uc744 \uc124\uc815\ud55c \ud6c4 \ud568\uc218\ub97c \ud638\ucd9c\ud558\uace0, \ud568\uc218\uac00 \uc885\ub8cc\ub418\uba74 \uc6d0\ub798 \uac12\uc73c\ub85c \ubcf5\uc6d0\ud558\ub294 \ubc29\uc2dd\uc744 \ubc18\ubcf5\uc801\uc73c\ub85c \uc0ac\uc6a9\ud574\uc57c\ud558\ub294 \uacbd\uc6b0\uac00 \uc788\uc2b5\ub2c8\ub2e4."}),"\n",(0,o.jsxs)(e.p,{children:["\uc774\ub54c ",(0,o.jsx)(e.code,{children:"contextlib.contextmanager"}),"\ub97c \uc0ac\uc6a9\ud558\uc5ec ",(0,o.jsx)(e.code,{children:"set"}),"\uacfc ",(0,o.jsx)(e.code,{children:"reset"}),"\uc744 \uac10\uc2f8\uace0, ",(0,o.jsx)(e.code,{children:"get"}),"\uc744 \uc704\ud55c \ud568\uc218\ub97c \ub530\ub85c \ub9cc\ub4e4\uc5b4 \ub178\ucd9c\uc2dc\ud0a4\uba74 \uac1c\ubc1c\uc790\uc758 \uc2e4\uc218\ub97c \uc904\uc77c \uc218 \uc788\uc2b5\ub2c8\ub2e4."]}),"\n",(0,o.jsx)(e.pre,{children:(0,o.jsx)(e.code,{className:"language-python",children:'from contextlib import contextmanager\nfrom contextvars import ContextVar\nfrom typing import Any, Generator\n\n_num_step = ContextVar[int]("num_step", default=0)\n\n\n@contextmanager\ndef with_next_step() -> Generator[None, Any, None]:\n    token = _num_step.set(_num_step.get() + 1)\n    try:\n        yield\n    finally:\n        _num_step.reset(token)\n\n\ndef get_step() -> int:\n    return _num_step.get()\n'})})]})}function p(n={}){const{wrapper:e}={...(0,r.R)(),...n.components};return e?(0,o.jsx)(e,{...n,children:(0,o.jsx)(d,{...n})}):d(n)}},28453:(n,e,t)=>{t.d(e,{R:()=>c,x:()=>a});var s=t(96540);const o={},r=s.createContext(o);function c(n){const e=s.useContext(r);return s.useMemo((function(){return"function"==typeof n?n(e):{...e,...n}}),[e,n])}function a(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(o):n.components||o:c(n.components),s.createElement(r.Provider,{value:e},n.children)}}}]);